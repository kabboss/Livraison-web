<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEND 2.0 - Interface Livreur Professionnelle</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066FF;
            --primary-blue-light: #3d8bff;
            --secondary-blue: #2563eb;
            --accent-orange: #F97316;
            --success: #22c55e;
            --success-light: #86efac;
            --warning: #f59e0b;
            --warning-light: #fcd34d;
            --error: #ef4444;
            --error-light: #fca5a5;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--gray-800);
            margin-top: 70px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === MENU HAMBURGER === */
        .menu-btn {
            position: fixed;
            top: 15px;
            left: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }

        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .menu-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 85%;
            max-width: 320px;
            height: 100%;
            background: white;
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 2rem 1rem;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .menu-drawer.active {
            transform: translateX(0);
        }

        .menu-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .menu-logo {
            width: 40px;
            height: 40px;
            margin-right: 0.5rem;
            border-radius: 0.5rem;
        }

        .menu-title {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--primary-blue);
            flex: 1;
        }

        .menu-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--gray-800);
            transition: transform 0.3s ease;
        }

        .menu-close:hover {
            transform: rotate(90deg);
        }

        .menu-list {
            list-style: none;
            flex: 1;
        }

        .menu-item {
            margin-bottom: 0.5rem;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            color: var(--gray-800);
            text-decoration: none;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .menu-link:hover {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            transform: translateX(5px);
        }

        .menu-link i {
            margin-right: 0.75rem;
            width: 24px;
        }

        .menu-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            font-size: 0.875rem;
            color: var(--gray-600);
            text-align: center;
        }

        /* === NAVIGATION === */
        .navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 999;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--gray-600);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 1.1rem;
        }

        .nav-btn:hover {
            background: var(--gray-100);
            color: var(--primary-blue);
        }

        .nav-title {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 1.1rem;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            background: var(--error);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .status-indicator.active {
            background: var(--success);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        .status-indicator.tracking {
            background: var(--accent-orange);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

/* === HEADER === */
.header {
    position: relative;
    text-align: center;
    margin-bottom: 2rem;
    padding: 3rem 2rem;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    border-radius: 24px;
    color: white;
    box-shadow: 0 15px 40px rgba(0, 102, 255, 0.3);
    overflow: hidden;
}

/* Camion animé */
.truck-animation {
    position: absolute;
    top: 20px;
    left: -100px;
    animation: drive 6s linear infinite;
}

.truck-icon {
    font-size: 3rem;
    color: white;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

@keyframes drive {
    0% {
        left: -100px;
        transform: translateY(0) rotateY(0deg);
    }
    50% {
        transform: translateY(-10px);
    }
    100% {
        left: 100%;
        transform: translateY(0);
    }
}

.title {
    font-size: 2.8rem;
    font-weight: 900;
    margin-bottom: 0.5rem;
    text-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    z-index: 1;
    position: relative;
}

.subtitle {
    font-size: 1.2rem;
    opacity: 0.95;
    max-width: 700px;
    margin: 0 auto;
    z-index: 1;
    position: relative;
}

        /* === CARTES DE STATUT === */
        .tracking-status-card, .location-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .tracking-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .tracking-toggle {
            width: 60px;
            height: 30px;
            background: var(--gray-300);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tracking-toggle.active {
            background: var(--success);
        }

        .tracking-toggle::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tracking-toggle.active::after {
            transform: translateX(30px);
        }

        .tracking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .tracking-metric {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .tracking-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }

        .tracking-metric-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* === LOCALISATION === */
        .location-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .accuracy-bars {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .accuracy-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            flex: 1;
            overflow: hidden;
        }

        .accuracy-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-blue-light));
            width: 0%;
            transition: width 0.5s ease;
        }

        .location-details {
            color: var(--gray-600);
            line-height: 1.6;
        }

        /* === FILTRES DE DISTANCE === */
        .professional-filters-android {
            background: white;
            border-radius: 16px;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .android-filter-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .android-filter-header:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        }

        .android-filter-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: var(--gray-50);
        }

        .android-filter-content.active {
            max-height: 600px;
        }

        .service-filter-card {
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
            background: white;
            margin: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .service-header > div:first-child {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .distance-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .distance-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--primary-blue);
            background: white;
            color: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .distance-btn:hover {
            background: var(--primary-blue);
            color: white;
            transform: scale(1.1);
        }

        .distance-value {
            min-width: 70px;
            text-align: center;
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .android-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--gray-200);
            outline: none;
            -webkit-appearance: none;
            margin-top: 1rem;
        }

        .android-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .android-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* === CONTRÔLES DE FILTRES === */
        .filter-controls {
            display: flex;
            gap: 2rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            flex-wrap: wrap;
        }

        .filter-switch {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: 0.4s;
            border-radius: 32px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: var(--primary-blue);
        }

        input:checked + .slider:before {
            transform: translateX(28px);
        }

        .filter-label {
            font-weight: 600;
            color: var(--gray-700);
            user-select: none;
            font-size: 1rem;
        }

        /* === INFO BOX === */
        .info-toggle-btn {
            background: var(--primary-blue);
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-toggle-btn:hover {
            background: var(--secondary-blue);
            transform: translateY(-2px);
        }

        .info-box {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--gray-200);
            margin-top: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .info-title {
            font-size: 1.3rem;
            color: var(--gray-800);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .info-subtitle {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            color: var(--primary-blue);
        }

        .info-text {
            font-size: 1rem;
            color: var(--gray-600);
            margin: 1rem 0;
            line-height: 1.6;
        }

        .info-list {
            list-style: none;
            padding-left: 0;
            margin: 1rem 0;
        }

        .info-list li {
            margin-bottom: 0.75rem;
            padding-left: 1rem;
            position: relative;
            line-height: 1.5;
        }

        .info-list li:before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--primary-blue);
            font-weight: bold;
        }

/* === SERVICES === */
.service-section {
    margin: 2rem 0;
    overflow-x: auto;
}

.service-buttons {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    padding-bottom: 1rem;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
}

.service-btn {
    min-width: 220px;
    flex: 0 0 auto;
    background: white;
    border: 3px solid var(--gray-200);
    border-radius: 16px;
    padding: 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
    scroll-snap-align: start;
}

/* Reste inchangé */
.service-btn:hover {
    border-color: var(--primary-blue);
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0, 102, 255, 0.15);
}

.service-btn.active {
    border-color: var(--primary-blue);
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: white;
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0, 102, 255, 0.3);
}

.service-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.service-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    display: block;
}

.service-label {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
}

.service-count {
    position: absolute;
    top: -1px;
    right: -5px;
    background: var(--accent-orange);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
    
        /* === COMMANDES === */
        .orders-container {
            position: relative;
        }

        .order-list {
            display: none;
            gap: 1.5rem;
            flex-direction: column;
        }

        .order-list.active {
            display: flex;
        }

        .compact-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.4s ease;
            border: 2px solid transparent;
            animation: slideInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .compact-card.assigned {
            border-color: var(--warning);
            background: linear-gradient(135deg, #fefce8, #fef3c7);
        }

        .compact-card.my-assignment {
            border-color: var(--success);
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .compact-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .compact-card-header {
            padding: 2rem;
            cursor: pointer;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1.5rem;
            align-items: center;
        }

        .compact-card-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.2rem;
        }

        .compact-card-service-icon {
            font-size: 1.5rem;
        }

        .compact-card-id {
            background: var(--gray-100);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 600;
        }

        .compact-card-info {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .assignment-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-self: end;
        }

        .assignment-badge.available {
            background: var(--success-light);
            color: var(--success);
        }

        .assignment-badge.my-assignment {
            background: var(--success);
            color: white;
        }

        .assignment-badge.other-assignment {
            background: var(--warning);
            color: white;
        }

        .compact-card-distance {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .distance-value {
            font-weight: 700;
            color: var(--primary-blue);
        }

        .compact-card-price {
            font-weight: 700;
            color: var(--success);
            font-size: 1.2rem;
            margin-top: 0.5rem;
        }

        .compact-card-toggle {
            color: var(--gray-400);
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        .compact-card.expanded .compact-card-toggle {
            transform: rotate(180deg);
        }

        /* === CARTES DÉTAILLÉES === */
        .order-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin-top: -1rem;
            margin-bottom: 1rem;
            display: none;
            animation: expandIn 0.4s ease-out forwards;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-top: 1px solid var(--gray-200);
        }

        @keyframes expandIn {
            from {
                opacity: 0;
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-top: 0;
            }
            to {
                opacity: 1;
                max-height: 5000px;
                padding-top: 2rem;
                padding-bottom: 2rem;
                margin-top: -1rem;
            }
        }

        .order-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .order-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .order-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .order-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-content {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary-blue);
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-icon {
            color: var(--primary-blue);
            width: 20px;
            font-size: 1.1rem;
            margin-top: 0.2rem;
        }

        .distance-info {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .distance-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            font-weight: 600;
        }

        .distance-item i {
            color: var(--accent-orange);
            font-size: 1.2rem;
        }

        /* === LOCALISATION === */
        .section-localisation {
            margin: 2rem 0;
            padding: 2rem;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 16px;
            border: 2px solid #0ea5e9;
        }

        .localisation-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 2rem;
        }

        .location-block {
            display: grid;
            gap: 2rem;
        }

        .location-item {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .location-item p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .btn-map {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #0ea5e9;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
        }

        .btn-map:hover {
            background: #0284c7;
            transform: translateY(-2px);
        }

        .precision {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-style: italic;
        }

        /* === PHOTOS === */
        .package-photos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .package-photo {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .package-photo:hover {
            transform: scale(1.05);
        }

        .package-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .no-photo-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: var(--gray-100);
            color: var(--gray-500);
            text-align: center;
            font-size: 0.9rem;
        }

        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .package-photo:hover .photo-overlay {
            opacity: 1;
        }

        .photo-overlay i {
            color: white;
            font-size: 1.5rem;
        }

        /* === PACKAGE TYPE BADGE === */
        .package-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        .package-type-badge.petit {
            background: var(--success-light);
            color: var(--success);
        }

        .package-type-badge.moyen {
            background: var(--warning-light);
            color: var(--warning);
        }

        .package-type-badge.gros {
            background: var(--error-light);
            color: var(--error);
        }

        .package-type-badge.fragile {
            background: #ddd6fe;
            color: #7c3aed;
        }

        .package-type-badge.express {
            background: #fef3c7;
            color: #d97706;
        }

        /* === BOUTONS === */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--gray-100);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 102, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #16a34a, var(--success));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, var(--warning));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        /* === ASSIGNMENT ALERT === */
        .assignment-alert {
            background: linear-gradient(135deg, var(--warning-light), #fed7aa);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #92400e;
            font-weight: 600;
            text-align: center;
        }

        .alert-icon {
            font-size: 2rem;
        }

        .alert-text {
            flex: 1;
            font-size: 1.1rem;
        }

        /* === ÉTATS === */
        .loading-state, .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-200);
            border-top: 5px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.8;
        }

        .empty-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .empty-message {
            font-size: 1rem;
            line-height: 1.5;
        }

        /* === MODALES === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 2.5rem 2.5rem 2rem;
            border-bottom: 2px solid var(--gray-100);
            text-align: center;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .form-scroll {
            max-height: 400px;
            overflow-y: auto;
            padding: 2rem 2.5rem;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.1);
            background: #fafbff;
        }

        .modal-actions {
            padding: 2rem 2.5rem 2.5rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            border-top: 2px solid var(--gray-100);
        }

        /* === SMS MODAL === */
        .sms-modal-content {
            max-width: 700px;
        }

        .sms-section {
            margin-bottom: 2rem;
        }

        .sms-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .sms-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
            background: var(--gray-50);
            color: var(--gray-700);
            margin-bottom: 1rem;
        }

        .sms-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sms-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
        }

        .sms-btn:disabled {
            background: var(--success);
            cursor: not-allowed;
        }

        /* === TOASTS === */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border-left: 4px solid var(--primary-blue);
            animation: toastSlideIn 0.4s ease-out;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast-icon {
            font-size: 1.3rem;
            margin-top: 0.1rem;
        }

        .toast-icon.success {
            color: var(--success);
        }

        .toast-icon.error {
            color: var(--error);
        }

        .toast-icon.warning {
            color: var(--warning);
        }

        .toast-icon.info {
            color: var(--primary-blue);
        }

        .toast-message {
            flex: 1;
            font-weight: 500;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0;
        }

        .toast-close:hover {
            color: var(--gray-600);
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* === TRACKING NOTIFICATION === */
        .tracking-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            border-left: 4px solid var(--accent-orange);
            max-width: 350px;
        }

        .tracking-notification.active {
            transform: translateY(0);
            opacity: 1;
        }

        .tracking-notification-icon {
            color: var(--accent-orange);
            font-size: 1.3rem;
            animation: pulse 2s infinite;
        }

        .tracking-notification-content {
            flex: 1;
        }

        .tracking-notification-title {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .tracking-notification-message {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .tracking-notification-close {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .tracking-notification-close:hover {
            color: var(--gray-600);
        }

        /* === GPS PRECISION OVERLAY === */
        .gps-precision-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,102,255,0.9), rgba(37,99,235,0.9));
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .gps-precision-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            animation: float 10s linear infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-10vh) rotate(360deg);
            }
        }

        .gps-precision-container {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            z-index: 1;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .gps-precision-icon {
            font-size: 4rem;
            color: var(--accent-orange);
            margin-bottom: 1.5rem;
            animation: pulse 2s infinite;
        }

        .gps-precision-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .gps-precision-message {
            color: var(--gray-600);
            margin-bottom: 2rem;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .gps-precision-details {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .gps-precision-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .gps-precision-detail:last-child {
            margin-bottom: 0;
        }

        .gps-precision-value {
            font-weight: 700;
            color: var(--primary-blue);
        }

        .gps-precision-progress {
            width: 100%;
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }

        .gps-precision-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning), var(--accent-orange));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .gps-precision-progress-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 0.8rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .gps-precision-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0 auto;
        }

        .gps-precision-btn:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            transform: translateY(-2px);
        }

        /* === MODAL PHOTO === */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .photo-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .photo-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .photo-modal-close {
            position: absolute;
            top: -50px;
            right: -10px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--gray-800);
        }

        .photo-modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        /* === IMAGE MODAL === */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .image-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .close-modal {
            position: absolute;
            top: 30px;
            right: 50px;
            background: rgba(255,255,255,0.9);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gray-800);
            z-index: 1;
        }

        .modal-content.image-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .service-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .service-btn {
                padding: 1.5rem;
            }

            .service-icon {
                font-size: 2rem;
            }

            .service-label {
                font-size: 1rem;
            }
            
            .compact-card-header {
                grid-template-columns: 1fr;
                gap: 1rem;
                text-align: left;
            }

            .assignment-badge {
                justify-self: start;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 1rem;
            }

            .service-filter-card {
                padding: 1.5rem;
            }

            .service-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
            }

            .modal-header {
                padding: 2rem 1.5rem 1.5rem;
            }

            .form-scroll {
                padding: 1.5rem;
            }

            .modal-actions {
                padding: 1.5rem;
                flex-direction: column;
            }

            .toast-container {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }

            .tracking-notification {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }

            .gps-precision-container {
                padding: 2rem;
                width: 95%;
            }

            .package-photos {
                grid-template-columns: repeat(2, 1fr);
            }

            .distance-info {
                grid-template-columns: 1fr;
            }

            .location-block {
                gap: 1.5rem;
            }

            .location-item {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .service-buttons {
                grid-template-columns: 1fr;
            }

            .compact-card {
                margin: 0 -1rem;
                border-radius: 12px;
            }

            .order-card {
                margin: 1rem -1rem;
                border-radius: 12px;
            }

            .tracking-status-card, .location-card {
                margin: 1rem -1rem;
                border-radius: 12px;
            }

            .professional-filters-android {
                margin: 1rem -1rem;
                border-radius: 12px;
            }

            .filter-controls {
                margin: 1rem -1rem;
                border-radius: 12px;
            }
        }

        /* === CUSTOM SCROLLBAR === */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* === UTILITIES === */
        .clickable-image {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clickable-image:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .completion-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--success-light);
            border-radius: 8px;
            color: var(--success);
            font-weight: 600;
            margin-top: 1rem;
        }

        .completion-indicator i {
            font-size: 1.2rem;
        }



        .sms-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Ajoutez ce style pour le bouton WhatsApp */
.sms-btn.whatsapp {
    background: linear-gradient(135deg, #25D366, #128C7E);
}

.sms-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.sms-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}



    </style>
</head>
<body>
    <!-- Menu Hamburger -->
    <div class="menu-btn" id="menuBtn">
        <i class="fas fa-bars"></i>
    </div>

    <div class="menu-overlay" id="menuOverlay"></div>

    <div class="menu-drawer" id="menuDrawer">
        <div class="menu-header">
            <img src="img/ChatGPT Image 30 avr. 2025, 20_34_02.png" alt="SEND Logo" class="menu-logo">
            <span class="menu-title">SEND 2.0</span>
            <button class="menu-close" id="menuClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <ul class="menu-list">
            <li class="menu-item"><a href="index.html" class="menu-link"><i class="fas fa-home"></i> Accueil</a></li>
            <li class="menu-item"><a href="client.html" class="menu-link"><i class="fas fa-shopping-bag"></i> Recevoir</a></li>
            <li class="menu-item"><a href="expediteur.html" class="menu-link"><i class="fas fa-paper-plane"></i> Expédier</a></li>
            <li class="menu-item"><a href="suivi.html" class="menu-link"><i class="fas fa-search-location"></i> Suivi de colis</a></li>
            <li class="menu-item"><a href="inscription_restau.html" class="menu-link"><i class="fas fa-utensils"></i> Partenariat Restaurant</a></li>
            <li class="menu-item"><a href="services.html" class="menu-link"><i class="fas fa-concierge-bell"></i> Services</a></li>
            <li class="menu-item"><a href="inscription.html" class="menu-link"><i class="fas fa-motorcycle"></i> Devenir Livreur</a></li>
            <li class="menu-item"><a href="Connection.html" class="menu-link"><i class="fas fa-sign-in-alt"></i> Connexion Livreur</a></li>
            <li class="menu-item"><a href="assistance.html" class="menu-link"><i class="fas fa-headset"></i> Assistance</a></li>
        </ul>

        <div class="menu-footer">
            SEND 2.0 &copy; 2025<br>
            Tous droits réservés
        </div>
    </div>

    <!-- Overlay de précision GPS -->
    <div class="gps-precision-overlay" id="gpsPrecisionOverlay">
        <div class="particles" id="particles"></div>
        <div class="gps-precision-container">
            <div class="gps-precision-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            
            <h2 class="gps-precision-title">Précision GPS insuffisante</h2>
            <p class="gps-precision-message">
                Pour une expérience optimale et une meilleure prise en charge des commandes,
                nous avons besoin d'une précision GPS d'au moins 50 mètres.
            </p>
            
            <div class="gps-precision-details">
                <div class="gps-precision-detail">
                    <span>Précision actuelle:</span>
                    <span class="gps-precision-value" id="currentAccuracy">-- m</span>
                </div>
                <div class="gps-precision-detail">
                    <span>Précision requise:</span>
                    <span class="gps-precision-value">≤ 50 m</span>
                </div>
                <div class="gps-precision-detail">
                    <span>Satellites détectés:</span>
                    <span class="gps-precision-value" id="satelliteCount">--</span>
                </div>
            </div>
            
            <div class="gps-precision-progress">
                <div class="gps-precision-progress-fill" id="accuracyProgress"></div>
                <div class="gps-precision-progress-label" id="accuracyProgressLabel">0%</div>
            </div>
            
            <button class="gps-precision-btn" id="retryGpsBtn">
                <i class="fas fa-redo"></i>
                Actualiser la localisation
            </button>
        </div>
    </div>

    <!-- Navigation fixe -->
    <div class="navigation">
        <div class="nav-left">
            <a href="Connection.html" class="nav-btn" title="Retour à la connexion">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="nav-title">Interface Livreur SEND 2.0</div>
        </div>
        <div class="nav-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Initialisation...</span>
        </div>
    </div>

    <div class="container">
        <!-- Header avec logo -->
<div class="header">
    <div class="truck-animation">
        <i class="fas fa-shipping-fast truck-icon"></i>
    </div>
    <h1 class="title">SEND 2.0 Livreur</h1>
    <p class="subtitle">Gérez vos livraisons en temps réel</p>
</div>

        <!-- Carte de statut de suivi GPS -->
        <div class="tracking-status-card">
            <div class="tracking-header">
                <div class="tracking-title">
                    <i class="fas fa-satellite-dish"></i>
                    Suivi GPS Avancé
                </div>
                <div class="tracking-toggle" id="trackingToggle"></div>
            </div>
            <div class="tracking-info">
                <div class="tracking-metric">
                    <div class="tracking-metric-value" id="trackingAccuracy">--</div>
                    <div class="tracking-metric-label">Précision</div>
                </div>

                <div class="tracking-metric">
                    <div class="tracking-metric-value" id="positionsSent">0</div>
                    <div class="tracking-metric-label">Positions</div>
                </div>

                <div class="tracking-metric">
                    <div class="tracking-metric-value" id="trackingStatus">Inactif</div>
                    <div class="tracking-metric-label">Statut</div>
                </div>
                <div class="tracking-metric">
                    <div class="tracking-metric-value" id="trackingDuration">00:00</div>
                    <div class="tracking-metric-label">Durée</div>
                </div>
            </div>
        </div>

        <!-- Carte de localisation -->
        <div class="location-card">
            <div class="location-status" id="locationStatus">
                <i class="fas fa-clock"></i>
                <span>Initialisation de la localisation...</span>
            </div>
            <div class="accuracy-bars" id="accuracyBars">
                <div class="accuracy-bar">
                    <div class="accuracy-progress"></div>
                </div>
                <div class="accuracy-bar">
                    <div class="accuracy-progress"></div>
                </div>
                <div class="accuracy-bar">
                    <div class="accuracy-progress"></div>
                </div>
                <div class="accuracy-bar">
                    <div class="accuracy-progress"></div>
                </div>
            </div>
            <div class="location-details" id="locationDetails">
                Activez votre GPS pour une localisation précise et commencer à recevoir des commandes adaptées à vos préférences.
            </div>
        </div>

        <!-- Section Préférences de distance -->
        <div class="professional-filters-android">
            <div class="android-filter-header" onclick="toggleFilters()">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-sliders-h"></i>
                    <span>Réglages des distances</span>
                </div>
                <i class="fas fa-chevron-down" id="filterArrow"></i>
            </div>

            <div class="android-filter-content" id="filterContent">
                <!-- Colis -->
                <div class="service-filter-card" data-service="packages">
                    <div class="service-header">
                        <div>
                            <i class="fas fa-box-open" style="color: var(--primary-blue);"></i>
                            <span>Distance aux expéditeurs</span>
                        </div>
                        <div class="distance-controls">
                            <button class="distance-btn minus" data-service="packages">-</button>
                            <span class="distance-value">15 km</span>
                            <button class="distance-btn plus" data-service="packages">+</button>
                        </div>
                    </div>
                    <input type="range" min="1" max="50" value="15" 
                           class="android-slider" id="packagesDistance">
                </div>

                <!-- Nourriture -->
                <div class="service-filter-card" data-service="food">
                    <div class="service-header">
                        <div>
                            <i class="fas fa-utensils" style="color: var(--accent-orange);"></i>
                            <span>Distance aux restaurants</span>
                        </div>
                        <div class="distance-controls">
                            <button class="distance-btn minus" data-service="food">-</button>
                            <span class="distance-value">10 km</span>
                            <button class="distance-btn plus" data-service="food">+</button>
                        </div>
                    </div>
                    <input type="range" min="1" max="50" value="10" 
                           class="android-slider" id="foodDistance">
                </div>

                <!-- Courses -->
                <div class="service-filter-card" data-service="shopping">
                    <div class="service-header">
                        <div>
                            <i class="fas fa-shopping-basket" style="color: var(--success);"></i>
                            <span>Distance aux clients</span>
                        </div>
                        <div class="distance-controls">
                            <button class="distance-btn minus" data-service="shopping">-</button>
                            <span class="distance-value">10 km</span>
                            <button class="distance-btn plus" data-service="shopping">+</button>
                        </div>
                    </div>
                    <input type="range" min="1" max="50" value="10" 
                           class="android-slider" id="shoppingDistance">
                </div>

                <!-- Pharmacie -->
                <div class="service-filter-card" data-service="pharmacy">
                    <div class="service-header">
                        <div>
                            <i class="fas fa-prescription-bottle-alt" style="color: var(--error);"></i>
                            <span>Distance aux clients</span>
                        </div>
                        <div class="distance-controls">
                            <button class="distance-btn minus" data-service="pharmacy">-</button>
                            <span class="distance-value">10 km</span>
                            <button class="distance-btn plus" data-service="pharmacy">+</button>
                        </div>
                    </div>
                    <input type="range" min="1" max="50" value="10" 
                           class="android-slider" id="pharmacyDistance">
                </div>
            </div>
        </div>

        <!-- Informations et conseils pour les livreurs -->
        <section>
            <button class="info-toggle-btn" onclick="toggleInfoBox()">
                <i class="fas fa-info-circle"></i>
                Informations et Conseils Livreurs
            </button>
        </section>

        <div class="info-box" id="infoBox" style="display: none;">
            <h3 class="info-title">📍 Détails sur la distance affichée</h3>
            <p class="info-text">
                La distance affichée sert à estimer le trajet à effectuer selon le service sélectionné. Elle est calculée automatiquement en fonction de votre position GPS actuelle.
            </p>

            <ul class="info-list">
                <li><strong>📦 Colis :</strong> distance entre votre position et celle de l'expéditeur.</li>
                <li><strong>🍔 Nourriture :</strong> distance entre votre position et le restaurant.</li>
                <li><strong>💊 Pharmacie :</strong> distance entre vous et le client destinataire.</li>
                <li><strong>🛍️ Course :</strong> distance entre vous et le client à livrer.</li>
            </ul>

            <p class="info-text">
                ⚠️ La distance facturée pour les <strong>colis</strong> correspond au trajet entre l'expéditeur et le destinataire. Pour optimiser vos gains, ciblez les expéditeurs les plus proches afin d'éviter les longs trajets non rémunérés.
            </p>

            <h3 class="info-title">💰 Détails sur le prix et vos gains</h3>
            <p class="info-text">
                Le prix affiché est votre <strong>gain brut</strong>, c'est-à-dire <u>avant déduction des taxes</u>. Une taxe de <strong>10%</strong> doit être versée à l'entreprise sur chaque livraison. <em>Exemple : si vous effectuez une livraison de 1000 FCFA, 100 FCFA doit être versé à l'entreprise</em>
            </p>

            <h4 class="info-subtitle">📦 Tarification des Colis</h4>
            <p class="info-text">
                Vos gains dépendent du type de colis transporté et de la distance entre l'expéditeur et le destinataire :
            </p>

            <ul class="info-list">
                <li><strong>Petit colis</strong> (documents, repas, petits objets) :<br>
                    👉 700 F pour une distance ≤ 5 km<br>
                    👉 +100 F pour chaque kilomètre supplémentaire
                </li>
                <li><strong>Moyen colis</strong> (transportable à moto) :<br>
                    👉 1000 F pour ≤ 5 km<br>
                    👉 +120 F/km supplémentaire
                </li>
                <li><strong>Gros colis</strong> (meubles, électroménagers) :<br>
                    👉 2000 F pour ≤ 5 km<br>
                    👉 +250 F/km supplémentaire
                </li>
                <li><strong>Colis Fragile VIP</strong> (objets sensibles avec protection renforcée) :<br>
                    👉 1500 F pour ≤ 5 km<br>
                    👉 +200 F/km supplémentaire
                </li>
            </ul>

            <h4 class="info-subtitle">🍔 Tarification des Commandes Nourriture</h4>
            <ul class="info-list">
                <li>👉 700 F pour une distance ≤ 5 km entre le restaurant et le client</li>
                <li>👉 +100 F pour chaque kilomètre au-delà</li>
            </ul>

            <h4 class="info-subtitle">💊 Pharmacie & 🛍️ Courses</h4>
            <p class="info-text">
                Pour ces services, le prix est <strong>fixe</strong> : <strong>1000 F</strong> par course. 
            </p>
            <p class="info-text">
                ✅ Acceptez uniquement si vous êtes proche du client et capable de réaliser les tâches demandées.
            </p>

            <h3 class="info-title">📌 Conseils pour Maximiser vos Gains</h3>
            <ul class="info-list">
                <li>✅ Privilégiez les expéditeurs proches pour éviter des trajets à vide</li>
                <li>✅ Refusez les courses longues avec faible gain</li>
                <li>✅ Anticipez vos coûts (carburant, temps de déplacement...)</li>
                <li>✅ Préférez les petits colis rapides à livrer en série si vous êtes en ville</li>
                <li>✅ En cas de doute, contactez le support</li>
            </ul>

            <p class="info-text">
                🧾 N'oubliez pas que tous vos gains sont <strong>hors taxe</strong>. Une retenue de 10% sera appliquée par l'entreprise.
            </p>
        </div>

        <!-- Contrôles de filtre -->
        <div class="filter-controls">
            <div class="filter-switch">
                <label class="switch">
                    <input type="checkbox" id="showAvailableFilter" checked>
                    <span class="slider"></span>
                </label>
                <span class="filter-label">Afficher les disponibles</span>
            </div>
            
            <div class="filter-switch">
                <label class="switch">
                    <input type="checkbox" id="showAssignedFilter" checked>
                    <span class="slider"></span>
                </label>
                <span class="filter-label">Afficher les assignées</span>
            </div>

            <div class="filter-switch">
                <label class="switch">
                    <input type="checkbox" id="showMyOrdersOnly">
                    <span class="slider"></span>
                </label>
                <span class="filter-label">Mes assignations uniquement</span>
            </div>
        </div>

        <!-- Section des services -->
        <div class="service-section">
            <div class="service-buttons">
                <button class="service-btn" id="btn-packages" disabled>
                    <div class="service-icon">📦</div>
                    <div class="service-label">Colis</div>
                    <div class="service-count" id="count-packages">0</div>
                </button>
                <button class="service-btn" id="btn-food" disabled>
                    <div class="service-icon">🍔</div>
                    <div class="service-label">Nourriture</div>
                    <div class="service-count" id="count-food">0</div>
                </button>
                <button class="service-btn" id="btn-shopping" disabled>
                    <div class="service-icon">🛍️</div>
                    <div class="service-label">Courses</div>
                    <div class="service-count" id="count-shopping">0</div>
                </button>
                <button class="service-btn" id="btn-pharmacy" disabled>
                    <div class="service-icon">💊</div>
                    <div class="service-label">Pharmacie</div>
                    <div class="service-count" id="count-pharmacy">0</div>
                </button>
            </div>
        </div>

        <!-- Conteneur des commandes -->
        <div class="orders-container">
            <div id="packages-list" class="order-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Chargement des colis...</div>
                </div>
            </div>
            
            <div id="food-list" class="order-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Chargement des commandes de nourriture...</div>
                </div>
            </div>
            
            <div id="shopping-list" class="order-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Chargement des demandes de courses...</div>
                </div>
            </div>
            
            <div id="pharmacy-list" class="order-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Chargement des commandes de pharmacie...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification de suivi actif -->
    <div class="tracking-notification" id="trackingNotification">
        <div class="tracking-notification-icon">
            <i class="fas fa-satellite-dish"></i>
        </div>
        <div class="tracking-notification-content">
            <div class="tracking-notification-title">Suivi GPS Actif</div>
            <div class="tracking-notification-message">Votre position est mise à jour automatiquement</div>
        </div>
        <button class="tracking-notification-close" onclick="app.hideTrackingNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Modal d'acceptation de commande -->
    <div id="acceptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Accepter la commande</h3>
                <p class="modal-subtitle">Veuillez renseigner vos informations de livreur</p>
            </div>
            <form id="acceptForm" class="modal-form">
                <div class="form-scroll">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user"></i> Nom complet</label>
                        <input type="text" class="form-input" id="driverName" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-id-card"></i> Identifiant livreur</label>
                        <input type="text" class="form-input" id="driverId" placeholder="Votre identifiant unique" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone"></i> Téléphone principal</label>
                        <input type="tel" class="form-input" id="driverPhone1" placeholder="+226 XX XX XX XX" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone-alt"></i> Téléphone secondaire (optionnel)</label>
                        <input type="tel" class="form-input" id="driverPhone2" placeholder="+226 XX XX XX XX">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAccept">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="confirmAccept">
                        <span class="btn-text">Accepter la commande</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal d'envoi de SMS obligatoire -->
    <div id="smsModal" class="modal">
        <div class="modal-content sms-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🚨 Notification Obligatoire aux Clients</h3>
                <p class="modal-subtitle">Vous devez informer les parties concernées avant de continuer</p>
            </div>
            
            <div style="padding: 2rem;">
                <div class="sms-section">
                    <div class="sms-label">
                        <i class="fas fa-user-tie"></i>
                        Message pour l'expéditeur (<span id="expediteurPhone">--</span>)
                    </div>
                    <textarea class="sms-textarea" id="smsExpediteur" readonly></textarea>
                    <button class="sms-btn" id="sendExpediteurSms">
                        <i class="fas fa-sms"></i>
                        Envoyer SMS à l'expéditeur
                    </button>
                </div>
                
                <div class="sms-section">
                    <div class="sms-label">
                        <i class="fas fa-user-check"></i>
                        Message pour le destinataire (<span id="destinatairePhone">--</span>)
                    </div>
                    <textarea class="sms-textarea" id="smsDestinataire" readonly></textarea>
                    <button class="sms-btn" id="sendDestinataireSms">
                        <i class="fas fa-sms"></i>
                        Envoyer SMS au destinataire
                    </button>
                </div>
                
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 1.5rem; margin: 2rem 0;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; color: #92400e; font-weight: 700;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Attention : Étape Obligatoire</span>
                    </div>
                    <p style="margin-top: 1rem; color: #92400e; line-height: 1.5;">
                        Vous devez envoyer les deux SMS avant de pouvoir finaliser l'acceptation de cette commande. 
                        Cela garantit que toutes les parties sont informées de la prise en charge.
                    </p>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelSms">Annuler l'acceptation</button>
                    <button type="button" class="btn btn-primary" id="confirmSms" disabled>
                        <span class="btn-text">Finaliser l'acceptation</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de finalisation -->
    <div id="completeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Finaliser la livraison</h3>
                <p class="modal-subtitle">Confirmez la livraison réussie de la commande</p>
            </div>
            <form id="completeForm">
                <div class="form-scroll">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>
                            Nom du livreur
                        </label>
                        <input type="text" class="form-input" id="completeName" placeholder="Votre nom" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-id-card"></i>
                            Identifiant livreur
                        </label>
                        <input type="text" class="form-input" id="completeId" placeholder="Votre identifiant" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-sticky-note"></i>
                            Notes de livraison (optionnel)
                        </label>
                        <textarea class="form-input" id="completeNotes" rows="3" placeholder="Détails sur la livraison, observations particulières..."></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelComplete">Annuler</button>
                    <button type="submit" class="btn btn-success" id="confirmComplete">
                        <span class="btn-text">Finaliser la livraison</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de vérification d'identité -->
    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Vérification d'identité</h3>
                <p class="modal-subtitle">Confirmez votre identifiant pour mettre à jour votre position</p>
            </div>
            <form id="verifyForm">
                <div class="form-scroll">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-id-card"></i>
                            Identifiant livreur
                        </label>
                        <input type="text" class="form-input" id="verifyDriverId" placeholder="Votre identifiant" required>
                    </div>
                    <div class="completion-indicator">
                        <i class="fas fa-shield-alt"></i>
                        Cette vérification garantit la sécurité des livraisons
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelVerify">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="confirmVerify">
                        <span class="btn-text">Vérifier et continuer</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de photo -->
    <div id="photoModal" class="photo-modal">
        <div class="photo-modal-content">
            <button class="photo-modal-close" onclick="closePhotoModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="photoModalImage" src="" alt="Photo du colis">
        </div>
    </div>

    <!-- Container pour les toasts -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal d'image agrandie -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal" title="Fermer">&times;</span>
        <img class="modal-content image-content" id="modalImage" alt="Image agrandie" />
    </div>

    <script>
        // === CONFIGURATION ULTRA-AVANCÉE ===
        const APP_CONFIG = {
            API_BASE_URL: 'https://send20.netlify.app/.netlify/functions/',
            
            GEOLOCATION: {
                HIGH_ACCURACY: true,
                TIMEOUT: 15000,
                MAX_AGE: 0,
                MAX_ATTEMPTS: 5,
                DESIRED_ACCURACY: 5000,
                RETRY_DELAY: 2000
            },
            
            TRACKING: {
                BACKGROUND_MESSAGE: "Suivi de livraison SEND 2.0 en cours",
                BACKGROUND_TITLE: "SEND 2.0 Livreur",
                DISTANCE_FILTER: 50,
                INTERVAL: 300000,
                STATIONARY_RADIUS: 30,
                STOP_TIMEOUT: 5,
                CHECK_INTERVAL: 1800000,
                POSITION_SEND_INTERVAL: 120000
            },
            
            FILTERS: {
                DEFAULT_MAX_DISTANCE: 15,
                MIN_DISTANCE: 1,
                MAX_DISTANCE: 50
            },
            
            CACHE_DURATION: 5 * 60 * 1000,
            REFRESH_INTERVAL: 30000,
            
            PRICING: {
                BASE_DISTANCE: 5,
                PRICES: {
                    petit: { base: 700, additional: 100 },
                    moyen: { base: 1000, additional: 120 },
                    gros: { base: 2000, additional: 250 },
                    fragile: { base: 1500, additional: 200 },
                    express: { base: 1200, additional: 150 }
                }
            }
        };

        // === DÉTECTION ENVIRONNEMENT ===
        const isNative = () => typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform();

        // === PLUGINS CAPACITOR AVEC FALLBACK === 
        const CapacitorPlugins = {
            get Geolocation() {
                return isNative() && Capacitor.Plugins.Geolocation ? Capacitor.Plugins.Geolocation : {
                    getCurrentPosition: (options) => new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            position => resolve({
                                coords: {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    speed: position.coords.speed,
                                    heading: position.coords.heading
                                },
                                timestamp: position.timestamp
                            }),
                            reject,
                            {
                                enableHighAccuracy: APP_CONFIG.GEOLOCATION.HIGH_ACCURACY,
                                timeout: APP_CONFIG.GEOLOCATION.TIMEOUT,
                                maximumAge: APP_CONFIG.GEOLOCATION.MAX_AGE
                            }
                        );
                    }),
                    requestPermissions: () => Promise.resolve({ location: 'granted' }),
                    checkPermissions: () => Promise.resolve({ location: 'granted' })
                };
            },
            
            get Toast() {
                return isNative() && Capacitor.Plugins.Toast ? Capacitor.Plugins.Toast : {
                    show: ({ text, duration = 'long', position = 'center' }) => {
                        console.log('Toast (fallback):', text);
                        return Promise.resolve();
                    }
                };
            },

            get Preferences() {
                return isNative() && Capacitor.Plugins.Preferences ? Capacitor.Plugins.Preferences : {
                    get: ({ key }) => Promise.resolve({ value: localStorage.getItem(key) }),
                    set: ({ key, value }) => {
                        localStorage.setItem(key, value);
                        return Promise.resolve();
                    },
                    remove: ({ key }) => {
                        localStorage.removeItem(key);
                        return Promise.resolve();
                    }
                };
            }
        };

        // === SYSTÈME DE FILTRES DE DISTANCE ===
        class DistanceFilterSystem {
            constructor() {
                this.distanceSettings = {
                    packages: 15,
                    food: 10,
                    shopping: 10,
                    pharmacy: 10
                };

                this.initSliders();
                this.loadSettings();
                this.setupButtons();
            }

            setupButtons() {
                document.querySelectorAll('.distance-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const service = btn.dataset.service;
                        const isPlus = btn.classList.contains('plus');
                        this.adjustDistance(service, isPlus ? 1 : -1);
                    });
                });
            }

            adjustDistance(service, change) {
                const slider = document.getElementById(`${service}Distance`);
                if (!slider) return;
                
                let newValue = parseInt(slider.value) + change;
                newValue = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), newValue));
                
                slider.value = newValue;
                slider.dispatchEvent(new Event('input'));
            }

            applyFilters() {
                if (!window.app || !window.app.state) return;
                
                const activeService = window.app.state.activeService;
                if (!activeService) return;

                window.app.applyFilters();
            }

            initSliders() {
                const services = ['packages', 'food', 'shopping', 'pharmacy'];
                
                services.forEach(service => {
                    const slider = document.getElementById(`${service}Distance`);
                    if (!slider) return;
                    
                    const valueDisplay = slider.closest('.service-filter-card')
                                        .querySelector('.distance-value');

                    slider.addEventListener('input', (e) => {
                        const value = e.target.value;
                        this.distanceSettings[service] = parseInt(value);
                        valueDisplay.textContent = `${value} km`;
                        this.saveSettings();
                        this.applyFilters();
                    });
                });
            }

            getTargetLocation(order, serviceType) {
                switch(serviceType) {
                    case 'packages':
                        return order.expediteur?.location;
                    case 'food':
                        return order.restaurant?.position || order.client?.position;
                    case 'shopping':
                    case 'pharmacy':
                        return order.clientPosition || order.client?.position;
                    default:
                        return null;
                }
            }

            saveSettings() {
                localStorage.setItem('distanceFilterSettings', 
                    JSON.stringify(this.distanceSettings));
            }

            loadSettings() {
                const saved = localStorage.getItem('distanceFilterSettings');
                if (saved) {
                    this.distanceSettings = JSON.parse(saved);
                    
                    Object.keys(this.distanceSettings).forEach(service => {
                        const slider = document.getElementById(`${service}Distance`);
                        if (slider) {
                            slider.value = this.distanceSettings[service];
                            slider.dispatchEvent(new Event('input'));
                        }
                    });
                }
            }
        }

        // Fonction helper globale
        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const arrow = document.getElementById('filterArrow');
            
            content.classList.toggle('active');
            content.style.maxHeight = content.classList.contains('active') 
                ? `${content.scrollHeight}px` : '0';
            
            arrow.classList.toggle('fa-chevron-down');
            arrow.classList.toggle('fa-chevron-up');
            
            if (window.distanceFilter) {
                window.distanceFilter.applyFilters();
            }
        }

        function toggleInfoBox() {
            const box = document.getElementById('infoBox');
            box.style.display = box.style.display === 'none' ? 'block' : 'none';
        }

        // === CLASSE PRINCIPALE ===
        class DeliveryInterface {
            constructor() {
                this.config = APP_CONFIG;
                this.ASSIGNMENT_DURATION = 3 * 60 * 60 * 1000;

                this.state = {
                    currentLocation: null,
                    isLocationAccurate: false,
                    locationAttempts: 0,
                    lastLocationUpdate: null,
                    
                    activeService: null,
                    onlineStatus: navigator.onLine,                    
                    filters: {
                        maxDistance: APP_CONFIG.FILTERS.DEFAULT_MAX_DISTANCE,
                        showAvailable: true,
                        showAssigned: true,
                        showMyOrdersOnly: false
                    },
                    
                    currentOrder: null,
                    assignedOrders: new Set(),
                    driverInfo: null,
                    currentUpdateOrderId: null,
                    allOrders: new Map(),
                    filteredOrders: new Map(),
                    
                    isTrackingActive: false,
                    trackingStartTime: null,
                    watcherId: null,
                    pendingPositions: [],
                    trackingCheckInterval: null,
                    positionsSent: 0,
                    trackingAccuracy: null,
                    
                    stats: {
                        ordersAccepted: 0,
                        ordersCompleted: 0,
                        totalDistance: 0,
                        averageAccuracy: 0,
                        sessionStart: Date.now()
                    }
                };

                this.dom = {
                    statusIndicator: document.getElementById('statusIndicator'),
                    statusText: document.getElementById('statusText'),
                    
                    locationStatus: document.getElementById('locationStatus'),
                    locationDetails: document.getElementById('locationDetails'),
                    accuracyBars: document.getElementById('accuracyBars'),
                    
                    serviceButtons: document.querySelectorAll('.service-btn'),
                    orderLists: {
                        packages: document.getElementById('packages-list'),
                        food: document.getElementById('food-list'),
                        shopping: document.getElementById('shopping-list'),
                        pharmacy: document.getElementById('pharmacy-list')
                    },
                    
                    modals: {
                        accept: document.getElementById('acceptModal'),
                        complete: document.getElementById('completeModal'),
                        verify: document.getElementById('verifyModal'),
                        photo: document.getElementById('photoModal'),
                        sms: document.getElementById('smsModal')
                    },
                    
                    toastContainer: document.getElementById('toastContainer'),
                    trackingNotification: document.getElementById('trackingNotification'),
                    
                    trackingToggle: document.getElementById('trackingToggle'),
                    trackingStatus: document.getElementById('trackingStatus'),
                    trackingDuration: document.getElementById('trackingDuration'),
                    positionsSent: document.getElementById('positionsSent'),
                    trackingAccuracy: document.getElementById('trackingAccuracy'),
                    
                    gpsPrecisionOverlay: document.getElementById('gpsPrecisionOverlay'),
                    currentAccuracy: document.getElementById('currentAccuracy'),
                    accuracyProgress: document.getElementById('accuracyProgress'),
                    accuracyProgressLabel: document.getElementById('accuracyProgressLabel'),
                    retryGpsBtn: document.getElementById('retryGpsBtn'),
                    satelliteCount: document.getElementById('satelliteCount'),

                    showAvailableFilter: document.getElementById('showAvailableFilter'),
                    showAssignedFilter: document.getElementById('showAssignedFilter'),
                    showMyOrdersOnly: document.getElementById('showMyOrdersOnly')
                };

                this.init();
            }

            async init() {
                try {
                    console.log('🚀 Initialisation SEND 2.0 Livreur Pro');
                    
                    await this.restoreSession();
                    this.setupEventListeners();
                    this.updateOnlineStatus();
                    this.createParticles();
                    
                    const hasPermission = await this.checkLocationPermission();
                    if (hasPermission) {
                        await this.getLocation();
                    }
                    
                    if (this.state.driverInfo?.driverId) {
                        await this.loadAssignedOrders();
                    }
                    
                    this.startAutoRefresh();
                    this.startTrackingDurationUpdate();
                    
                    setTimeout(() => {
                        document.body.classList.add('loaded');
                    }, 200);
                    
                    console.log('✅ Initialisation terminée avec succès');
                } catch (error) {
                    console.error('❌ Erreur d\'initialisation:', error);
                    this.showToast('Erreur lors de l\'initialisation de l\'application', 'error');
                }
            }

            async restoreSession() {
                try {
                    const { value } = await CapacitorPlugins.Preferences.get({ key: 'driverSession' });
                    if (value) {
                        const session = JSON.parse(value);
                        this.state.driverInfo = session.driverInfo || null;
                        this.state.stats = { ...this.state.stats, ...session.stats };
                        this.state.filters = { ...this.state.filters, ...session.filters };
                    }
                } catch (error) {
                    console.error('Erreur de restauration de session:', error);
                }
            }

            setupEventListeners() {
                try {
                    this.setupServiceButtons();
                    this.setupTrackingControls();
                    this.setupFilterControls();
                    this.setupModalBehaviors();
                    this.setupNetworkListeners();
                    this.setupFormHandlers();
                    this.setupCancelActions();
                    this.setupMenuHandlers();
                    this.setupImageModal();
                } catch (error) {
                    console.error('Erreur lors de la configuration des écouteurs:', error);
                    this.showToast('Erreur de configuration de l\'interface', 'error');
                }
            }

            setupServiceButtons() {
                if (!this.dom.serviceButtons?.length) return;

                this.dom.serviceButtons.forEach(btn => {
                    btn?.addEventListener('click', () => {
                        try {
                            this.selectService(btn);
                        } catch (error) {
                            console.error('Erreur sur le bouton de service:', error);
                        }
                    });
                });
            }

            setupTrackingControls() {
                this.dom.trackingToggle?.addEventListener('click', () => {
                    try {
                        this.toggleTracking();
                    } catch (error) {
                        console.error('Erreur sur le toggle de tracking:', error);
                    }
                });

                this.dom.retryGpsBtn?.addEventListener('click', () => {
                    try {
                        this.getLocation();
                    } catch (error) {
                        console.error('Erreur sur le bouton GPS:', error);
                    }
                });
            }

            setupFilterControls() {
                const setupFilter = (element, filterKey) => {
                    if (!element) return;
                    element.addEventListener('change', (e) => {
                        this.state.filters[filterKey] = e.target.checked;
                        this.applyFilters().catch(console.error);
                        this.saveSession().catch(console.error);
                    });
                };

                setupFilter(this.dom.showAvailableFilter, 'showAvailable');
                setupFilter(this.dom.showAssignedFilter, 'showAssigned');
                setupFilter(this.dom.showMyOrdersOnly, 'showMyOrdersOnly');
            }

            setupModalBehaviors() {
                if (!this.dom.modals) return;

                Object.values(this.dom.modals).forEach(modal => {
                    if (!modal) return;
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
            }

            setupNetworkListeners() {
                window.addEventListener('online', async () => {
                    try {
                        this.state.onlineStatus = true;
                        this.updateOnlineStatus();
                        this.showToast('Connexion Internet rétablie', 'success');
                        
                        if (this.state.activeService) {
                            await this.loadOrders(this.state.activeService);
                        }
                    } catch (error) {
                        console.error('Erreur gestion online:', error);
                    }
                });

                window.addEventListener('offline', () => {
                    this.state.onlineStatus = false;
                    this.updateOnlineStatus();
                    this.showToast('Mode hors-ligne activé', 'warning');
                });
            }

            setupFormHandlers() {
                const setupForm = (id, handler) => {
                    const form = document.getElementById(id);
                    if (form) {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            try {
                                handler.call(this);
                            } catch (error) {
                                console.error(`Erreur formulaire ${id}:`, error);
                            }
                        });
                    }
                };

                setupForm('acceptForm', this.acceptOrder);
                setupForm('completeForm', this.completeOrder);
                setupForm('verifyForm', this.verifyAndUpdatePosition);
            }

            setupCancelActions() {
                const cancelActions = ['cancelAccept', 'cancelComplete', 'cancelVerify', 'cancelSms'];

                cancelActions.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('click', () => {
                            Object.values(this.dom.modals).forEach(modal => {
                                if (modal) modal.classList.remove('active');
                            });
                        });
                    }
                });
            }

            setupMenuHandlers() {
                const menuBtn = document.getElementById('menuBtn');
                const menuOverlay = document.getElementById('menuOverlay');
                const menuDrawer = document.getElementById('menuDrawer');
                const menuClose = document.getElementById('menuClose');

                const openMenu = () => {
                    menuOverlay.classList.add('active');
                    menuDrawer.classList.add('active');
                    document.body.style.overflow = 'hidden';
                };

                const closeMenu = () => {
                    menuOverlay.classList.remove('active');
                    menuDrawer.classList.remove('active');
                    document.body.style.overflow = '';
                };

                menuBtn?.addEventListener('click', openMenu);
                menuClose?.addEventListener('click', closeMenu);
                menuOverlay?.addEventListener('click', closeMenu);
            }

            setupImageModal() {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                const closeBtn = modal.querySelector('.close-modal');

                document.body.addEventListener('click', function(e) {
                    if (e.target.classList.contains('clickable-image')) {
                        modal.style.display = "block";
                        modalImg.src = e.target.src;
                        modalImg.alt = e.target.alt || "Image agrandie";
                    }
                });

                closeBtn.onclick = function() {
                    modal.style.display = "none";
                    modalImg.src = "";
                };

                modal.onclick = function(event) {
                    if (event.target === modal) {
                        modal.style.display = "none";
                        modalImg.src = "";
                    }
                };
            }

            async checkLocationPermission() {
                try {
                    const { location } = await CapacitorPlugins.Geolocation.checkPermissions();
                    if (location === 'granted') return true;

                    const perms = await CapacitorPlugins.Geolocation.requestPermissions();
                    
                    if (perms.location === 'granted') {
                        await CapacitorPlugins.Preferences.set({
                            key: 'locationPermissionGranted',
                            value: 'true'
                        });
                        return true;
                    }
                    
                    this.showToast('La localisation est nécessaire pour utiliser cette application', 'error');
                    return false;
                } catch (error) {
                    console.error('Erreur vérification permissions:', error);
                    this.showToast('Erreur lors de la demande de localisation', 'error');
                    return false;
                }
            }

            async getLocation() {
                try {
                    const hasPermission = await this.checkLocationPermission();
                    if (!hasPermission) {
                        this.updateLocationStatus('Autorisation requise pour accéder à la localisation', 'error');
                        return;
                    }

                    this.updateLocationStatus('Localisation en cours...', 'info');
                    this.resetAccuracyBars();
                    this.createParticles();

                    for (let attempt = 1; attempt <= this.config.GEOLOCATION.MAX_ATTEMPTS; attempt++) {
                        try {
                            const position = await this.getCurrentPosition();
                            const { latitude, longitude, accuracy } = position.coords;

                            this.updateAccuracyBar(attempt - 1, accuracy);
                            this.updatePrecisionOverlay(accuracy);
                            this.state.trackingAccuracy = Math.round(accuracy);
                            this.updateTrackingMetrics();

                            if (accuracy <= this.config.GEOLOCATION.DESIRED_ACCURACY) {
                                this.state.currentLocation = { latitude, longitude, accuracy };
                                this.state.isLocationAccurate = true;
                                this.state.lastLocationUpdate = Date.now();
                                this.updateLocationStatus('Position précise obtenue', 'success');
                                this.updatePrecisionOverlay(null);
                                this.enableServices();
                                return;
                            } else if (attempt === this.config.GEOLOCATION.MAX_ATTEMPTS) {
                                this.state.currentLocation = { latitude, longitude, accuracy };
                                this.state.lastLocationUpdate = Date.now();
                                this.updateLocationStatus(`Position approximative (${accuracy.toFixed(0)}m)`, 'warning');
                                this.updatePrecisionOverlay(accuracy);
                                this.enableServices();
                                return;
                            }

                        } catch (error) {
                            console.error(`Erreur lors de la tentative ${attempt}:`, error);
                            this.updateAccuracyBar(attempt - 1, -1);
                            if (attempt === this.config.GEOLOCATION.MAX_ATTEMPTS) {
                                this.updateLocationStatus('Impossible d\'obtenir la position GPS', 'error');
                                return;
                            }
                        }

                        if (attempt < this.config.GEOLOCATION.MAX_ATTEMPTS) {
                            await new Promise(resolve => setTimeout(resolve, this.config.GEOLOCATION.RETRY_DELAY));
                        }
                    }
                } catch (err) {
                    console.error('Erreur générale lors de la localisation:', err);
                    this.updateLocationStatus('Erreur système de géolocalisation', 'error');
                }
            }

            createParticles() {
                const particlesContainer = document.getElementById('particles');
                if (!particlesContainer) return;
                
                particlesContainer.innerHTML = '';
                const particleCount = 25;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    const size = Math.random() * 4 + 2;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.opacity = Math.random() * 0.6 + 0.2;
                    particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                    particle.style.animationDelay = `${Math.random() * 5}s`;
                    
                    particlesContainer.appendChild(particle);
                }
            }

            updatePrecisionOverlay(accuracy) {
                if (!accuracy || accuracy <= this.config.GEOLOCATION.DESIRED_ACCURACY) {
                    this.dom.gpsPrecisionOverlay.classList.remove('active');
                    return;
                }
                
                this.dom.gpsPrecisionOverlay.classList.add('active');
                this.dom.currentAccuracy.textContent = `${Math.round(accuracy)} m`;
                
                const maxAccuracy = 200;
                const progress = Math.max(0, Math.min(100, ((maxAccuracy - accuracy) / maxAccuracy) * 100));
                this.dom.accuracyProgress.style.width = `${progress}%`;
                this.dom.accuracyProgressLabel.textContent = `${Math.round(progress)}%`;
                
                const satelliteCount = Math.max(3, Math.min(12, Math.round(15 - (accuracy / 20))));
                this.dom.satelliteCount.textContent = satelliteCount;
                
                if (accuracy <= 70) {
                    this.dom.accuracyProgress.style.background = 'linear-gradient(90deg, var(--warning), var(--warning-light))';
                } else {
                    this.dom.accuracyProgress.style.background = 'linear-gradient(90deg, var(--error), var(--error-light))';
                }
            }

            updateLocationStatus(message, type) {
                const icons = {
                    info: '<i class="fas fa-clock"></i>',
                    success: '<i class="fas fa-check-circle"></i>',
                    warning: '<i class="fas fa-exclamation-triangle"></i>',
                    error: '<i class="fas fa-times-circle"></i>'
                };

                this.dom.locationStatus.innerHTML = `
                    ${icons[type] || icons.info}
                    <span>${message}</span>
                `;

                const details = {
                    info: 'Recherche de votre position GPS avec haute précision...',
                    success: 'Vous pouvez maintenant recevoir des commandes adaptées à vos filtres.',
                    warning: 'Précision limitée. Activez le GPS haute précision pour de meilleures performances.',
                    error: 'Activez la géolocalisation dans les paramètres de votre appareil.'
                };

                this.dom.locationDetails.textContent = details[type] || details.info;
            }

            updateAccuracyBar(index, accuracy) {
                const bars = this.dom.accuracyBars.querySelectorAll('.accuracy-progress');
                if (bars[index]) {
                    if (accuracy > 0) {
                        const percentage = Math.min(100, (this.config.GEOLOCATION.DESIRED_ACCURACY / accuracy) * 100);
                        bars[index].style.width = `${percentage}%`;
                        bars[index].style.background = percentage >= 80 ? 
                            'linear-gradient(90deg, var(--success), var(--success-light))' : 
                            percentage >= 50 ?
                            'linear-gradient(90deg, var(--warning), var(--warning-light))' :
                            'linear-gradient(90deg, var(--error), var(--error-light))';
                    } else {
                        bars[index].style.width = '100%';
                        bars[index].style.background = 'linear-gradient(90deg, var(--error), var(--error-light))';
                    }
                }
            }

            resetAccuracyBars() {
                const bars = this.dom.accuracyBars.querySelectorAll('.accuracy-progress');
                bars.forEach(bar => {
                    bar.style.width = '0%';
                    bar.style.background = 'linear-gradient(90deg, var(--primary-blue), var(--primary-blue-light))';
                });
            }

            enableServices() {
                this.dom.serviceButtons.forEach(btn => {
                    btn.disabled = false;
                });
                this.showToast('Services activés - Vous pouvez maintenant charger les commandes', 'success');
                
                if (this.state.activeService && window.distanceFilter) {
                    window.distanceFilter.applyFilters();
                }
            }

            updateOnlineStatus() {
                if (this.state.onlineStatus) {
                    this.dom.statusIndicator.classList.add('active');
                    this.dom.statusText.textContent = 'En ligne';
                } else {
                    this.dom.statusIndicator.classList.remove('active');
                    this.dom.statusText.textContent = 'Hors ligne';
                }
            }

            async selectService(button) {
                this.dom.serviceButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const serviceType = button.id.replace('btn-', '');
                this.state.activeService = serviceType;
                
                Object.values(this.dom.orderLists).forEach(list => {
                    list.classList.remove('active');
                });
                
                this.dom.orderLists[serviceType].classList.add('active');
                
                await this.loadOrders(serviceType);
                
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            async loadOrders(serviceType) {
                if (!this.state.onlineStatus) {
                    this.showErrorState(serviceType, new Error('Aucune connexion Internet disponible'));
                    return;
                }

                const orderList = this.dom.orderLists[serviceType];
                if (!orderList) {
                    console.error(`Élément DOM non trouvé pour ${serviceType}`);
                    return;
                }
                
                orderList.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>Chargement des commandes ${serviceType}...</div>
                    </div>
                `;

                try {
                    const orders = await this.fetchOrdersFromAPI(serviceType);
                    this.state.allOrders.set(serviceType, orders);
                    
                    this.applyFilters();

                } catch (error) {
                    console.error(`Erreur chargement ${serviceType}:`, error);
                    this.showErrorState(serviceType, error);
                }
            }

            async fetchOrdersFromAPI(serviceType) {
                try {
                    const endpoint = `${this.config.API_BASE_URL}getOrders?serviceType=${serviceType}`;
                    const response = await fetch(endpoint);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.orders || [];
                } catch (error) {
                    console.error(`Erreur API ${serviceType}:`, error);
                    this.showToast(`Erreur de chargement des commandes ${serviceType}`, 'error');
                    return [];
                }
            }

            async applyFilters() {
                if (!this.state.activeService) return;

                const serviceType = this.state.activeService;
                const allOrders = this.state.allOrders.get(serviceType) || [];
                
                let filteredOrders = allOrders.filter(order => {
                    const isAssigned = this.isOrderAssigned(order);
                    const isMyOrder = this.isMyOrder(order);
                    
                    if (!this.state.filters.showAvailable && !isAssigned) return false;
                    if (!this.state.filters.showAssigned && isAssigned && !isMyOrder) return false;
                    if (this.state.filters.showMyOrdersOnly && !isMyOrder) return false;
                    
                    if (this.state.currentLocation && window.distanceFilter) {
                        const targetLocation = this.getTargetLocation(order, serviceType);
                        if (targetLocation) {
                            const distance = this.calculateDistance(targetLocation);
                            const maxDistance = window.distanceFilter.distanceSettings[serviceType];
                            if (distance !== 'N/A' && parseFloat(distance) > maxDistance) return false;
                        }
                    }
                    
                    return true;
                });

                this.state.filteredOrders.set(serviceType, filteredOrders);
                this.displayOrders(serviceType, filteredOrders);
                this.updateServiceCount(serviceType, filteredOrders.length);
            }

        displayOrders(serviceType, orders) {
            const orderList = this.dom.orderLists[serviceType];
            orderList.innerHTML = '';

            if (orders.length === 0) {
                orderList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📭</div>
                        <div class="empty-title">Aucune commande</div>
                        <div class="empty-message">
                            Aucune commande ne correspond à vos critères actuels
                        </div>
                    </div>
                `;
                return;
            }

            const sortedOrders = [...orders].sort((a, b) => {
                const aAssigned = this.isOrderAssigned(a);
                const bAssigned = this.isOrderAssigned(b);
                const aMyOrder = this.isMyOrder(a);
                const bMyOrder = this.isMyOrder(b);

                if (aMyOrder && !bMyOrder) return -1;
                if (!aMyOrder && bMyOrder) return 1;
                if (!aAssigned && bAssigned) return -1;
                if (aAssigned && !bAssigned) return 1;

                const distA = this.calculateDistance(this.getTargetLocation(a, serviceType)) || Infinity;
                const distB = this.calculateDistance(this.getTargetLocation(b, serviceType)) || Infinity;
                return distA - distB;
            });

            sortedOrders.forEach((order, index) => {
                const orderContainer = document.createElement('div');
                orderContainer.className = 'order-container';
                
                const compactCard = this.createCompactCard(serviceType, order, index);
                orderContainer.appendChild(compactCard);

                const fullCard = this.createOrderCard(serviceType, order);
                fullCard.style.display = 'none';
                fullCard.classList.add('full-card');
                orderContainer.appendChild(fullCard);

                const toggleBtn = compactCard.querySelector('.compact-card-header');
                toggleBtn.addEventListener('click', () => {
                    const isExpanded = compactCard.classList.toggle('expanded');
                    
                    // Fermer toutes les autres cartes détaillées
                    document.querySelectorAll('.order-container .order-card').forEach(card => {
                        if (card !== fullCard) {
                            card.style.display = 'none';
                            card.previousElementSibling.classList.remove('expanded');
                        }
                    });
                    
                    // Afficher/masquer cette carte détaillée
                    if (isExpanded) {
                        fullCard.style.display = 'block';
                        // Forcer le recalcul pour l'animation
                        setTimeout(() => {
                            fullCard.style.maxHeight = '5000px';
                        }, 10);
                    } else {
                        fullCard.style.maxHeight = '0';
                        setTimeout(() => {
                            fullCard.style.display = 'none';
                        }, 400);
                    }
                });

                orderList.appendChild(orderContainer);
            });
        }
        
            createCompactCard(serviceType, order, index) {
                const orderId = this.getOrderId(order, serviceType);
                const isAssigned = this.isOrderAssigned(order);
                const isMyOrder = this.isMyOrder(order);

                let packageTypeInfo = '';
                if (serviceType === 'packages' && order.colis?.type) {
                    const packageType = order.colis.type;
                    packageTypeInfo = `
                        <div class="package-type-badge ${packageType.toLowerCase()}">
                            ${this.getPackageTypeIcon(packageType)} ${packageType}
                        </div>
                    `;
                }
                
                const deliveryPrice = this.getOrderPrice(order, serviceType);
                const formattedPrice = deliveryPrice ? deliveryPrice.toLocaleString('fr-FR') : 'Prix à négocier';

                let assignationInfo = '';
                if (isMyOrder) {
                    assignationInfo = `
                        <div class="assignment-badge my-assignment">
                            <i class="fas fa-user-check"></i> Mes assignations
                        </div>
                    `;
                } else if (isAssigned) {
                    const driverName = order.driverName || order.nomLivreur || 'Autre livreur';
                    assignationInfo = `
                        <div class="assignment-badge other-assignment">
                            <i class="fas fa-user-clock"></i> Assigné à ${driverName}
                        </div>
                    `;
                } else {
                    assignationInfo = `
                        <div class="assignment-badge available">
                            <i class="fas fa-clock"></i> Disponible
                        </div>
                    `;
                }

                const serviceIcons = {
                    packages: '📦',
                    food: '🍔',
                    shopping: '🛍️',
                    pharmacy: '💊'
                };

                const serviceNames = {
                    packages: 'Colis',
                    food: 'Nourriture',
                    shopping: 'Courses',
                    pharmacy: 'Pharmacie'
                };

                const targetLocation = this.getTargetLocation(order, serviceType);
                let distance = 'N/A';
                if (targetLocation?.latitude && targetLocation?.longitude) {
                    distance = this.calculateDistance(targetLocation);
                }

                let cardClass = 'compact-card';
                if (isMyOrder) {
                    cardClass += ' my-assignment';
                } else if (isAssigned) {
                    cardClass += ' assigned';
                }

                const card = document.createElement('div');
                card.className = cardClass;
                card.dataset.orderId = orderId;
                card.style.animationDelay = `${index * 0.05}s`;

                card.innerHTML = `
                    <div class="compact-card-header">
                        <div>
                            <div class="compact-card-title">
                                <span class="compact-card-service-icon">${serviceIcons[serviceType]}</span>
                                ${serviceNames[serviceType]}
                                <span class="compact-card-id">#${orderId}</span>
                                ${packageTypeInfo}
                            </div>
                            <div class="compact-card-info">
                                <div class="compact-card-distance">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span class="distance-label">Distance:</span>
                                    <span class="distance-value">${distance} km</span>
                                </div>
                                
                                <div class="compact-card-price">
                                    Gain (Hors taxe): ${formattedPrice} XOF
                                </div>
                            </div>
                        </div>

                        <div>
                            ${assignationInfo}
                            <i class="fas fa-chevron-down compact-card-toggle"></i>
                        </div>
                    </div>
                `;

                return card;
            }

            getPackageTypeIcon(type) {
                const icons = {
                    petit: '📦',
                    moyen: '📦📦',
                    gros: '📦📦📦',
                    fragile: '🧳',
                    express: '⚡',
                    standard: '📦'
                };
                return icons[type.toLowerCase()] || icons.standard;
            }

            createOrderCard(serviceType, order) {
                const card = document.createElement('div');
                card.className = 'order-card';

                let cardContent = '';
                
                switch(serviceType) {
                    case 'packages':
                        cardContent = this.generatePackageCard(order);
                        break;
                    case 'food':
                        cardContent = this.generateFoodCard(order);
                        break;
                    case 'shopping':
                        cardContent = this.generateShoppingCard(order);
                        break;
                    case 'pharmacy':
                        cardContent = this.generatePharmacyCard(order);
                        break;
                }

                card.innerHTML = cardContent;
                this.setupCardEvents(card, order, serviceType);
                return card;
            }

            generatePackageCard(order) {
                const orderId = this.getOrderId(order, 'packages');
                const isAssigned = this.isOrderAssigned(order);
                const isMyOrder = this.isMyOrder(order);

                const normalizedData = {
                    id: orderId,
                    livraisonID: order.livraisonID || 'N/A',
                    status: order.statut || order.status || 'inconnu',

                    sender: {
                        name: order.expediteur?.nom || 'Non spécifié',
                        phone: this.formatPhoneNumber(order.expediteur?.telephone) || 'Non spécifié',
                        location: order.expediteur?.location ? {
                            latitude: this.cleanCoordinate(order.expediteur.location.latitude),
                            longitude: this.cleanCoordinate(order.expediteur.location.longitude),
                            precision: this.cleanCoordinate(order.expediteur.location.precision || order.expediteur.location.accuracy)
                        } : null
                    },

                    recipient: {
                        name: order.destinataire?.nom || 'Non spécifié',
                        phone: this.formatPhoneNumber(order.destinataire?.telephone) || 'Non spécifié',
                        address: order.destinataire?.adresse || 'Adresse non spécifiée',
                        location: order.destinataire?.location ? {
                            latitude: this.cleanCoordinate(order.destinataire.location.latitude),
                            longitude: this.cleanCoordinate(order.destinataire.location.longitude),
                            precision: this.cleanCoordinate(order.destinataire.location.precision || order.destinataire.location.accuracy)
                        } : null
                    },

                    package: {
                        type: order.colis?.type || order.packageType || 'standard',
                        description: order.colis?.description || '',
                        photos: order.colis?.photos || []
                    },

                    pricing: {
                        price: order.pricing?.price || 0,
                        distance: order.pricing?.distance || 'N/A',
                    },

                    payment: {
                        method: order.payment?.method || 'N/A',
                        status: order.payment?.status || 'non précisé',
                        amount: order.payment?.amount || 0,
                        currency: order.payment?.currency || 'XOF'
                    }
                };

                const senderDistance = normalizedData.sender.location 
                    ? this.calculateDistance(normalizedData.sender.location)
                    : 'N/A';
                    
                const deliveryDistance = normalizedData.recipient.location && normalizedData.sender.location
                    ? this.calculateDistanceBetween(
                        normalizedData.sender.location, 
                        normalizedData.recipient.location
                      )
                    : 'N/A';
                    
                const generateMapLink = (lat, lng) => `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;

                const photosSection = this.generatePhotosSection(normalizedData.package.photos);

                let assignmentBadge = '';
                if (isAssigned) {
                    if (isMyOrder) {
                        assignmentBadge = `
                            <div class="assignment-badge my-assignment">
                                <i class="fas fa-user-check"></i> Mes assignations
                            </div>
                        `;
                    } else {
                        const driverName = order.driverName || order.nomLivreur || 'Livreur';
                        assignmentBadge = `
                            <div class="assignment-badge other-assignment">
                                <i class="fas fa-user-clock"></i> Assigné à ${driverName}
                            </div>
                        `;
                    }
                }

                return `
                    <div class="order-header">
                        <div class="order-title">Colis #${normalizedData.id}</div>
                        <div class="order-subtitle">${normalizedData.livraisonID}</div>
                        ${assignmentBadge}
                    </div>

                    ${photosSection}

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-user-tie"></i> Expéditeur</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-user info-icon"></i><strong>${normalizedData.sender.name}</strong></div>
                            <div class="info-row"><i class="fas fa-phone info-icon"></i>${normalizedData.sender.phone}</div>
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-user-check"></i> Destinataire</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-user info-icon"></i><strong>${normalizedData.recipient.name}</strong></div>
                            <div class="info-row"><i class="fas fa-phone info-icon"></i>${normalizedData.recipient.phone}</div>
                            <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i>${normalizedData.recipient.address}</div>
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-box-open"></i> Détails du colis</div>
                        <div class="section-content">
                            <div class="info-row">
                                <i class="fas fa-tag info-icon"></i> Type : <strong>${normalizedData.package.type}</strong>
                            </div>
                            ${normalizedData.package.description ? `
                            <div class="info-row">
                                <i class="fas fa-info-circle info-icon"></i> Description : ${normalizedData.package.description}
                            </div>` : ''}
                        </div>
                    </div>

                    <section class="section-localisation">
                      <div class="localisation-container">
                        <h2 class="localisation-title">
                          <i class="fas fa-map-marked-alt"></i> Localisation géographique
                        </h2>
                        
                        <div class="location-block">
                          ${normalizedData.sender.location ? `
                            <div class="location-item">
                              <p><strong>📤 Expéditeur :</strong></p>
                              <p>Latitude : ${normalizedData.sender.location.latitude}, Longitude : ${normalizedData.sender.location.longitude}</p>
                              <a class="btn-map" href="${generateMapLink(normalizedData.sender.location.latitude, normalizedData.sender.location.longitude)}" target="_blank">
                                📍 Ouvrir dans Google Maps
                              </a>
                              <p class="precision">Précision : ±${Math.round(normalizedData.sender.location.precision)} m</p>
                            </div>
                          ` : ''}
                          
                          ${normalizedData.recipient.location ? `
                            <div class="location-item">
                              <p><strong>📩 Destinataire :</strong></p>
                              <p>Latitude : ${normalizedData.recipient.location.latitude}, Longitude : ${normalizedData.recipient.location.longitude}</p>
                              <a class="btn-map" href="${generateMapLink(normalizedData.recipient.location.latitude, normalizedData.recipient.location.longitude)}" target="_blank">
                                📍 Ouvrir dans Google Maps
                              </a>
                              <p class="precision">Précision : ±${Math.round(normalizedData.recipient.location.precision)} m</p>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </section>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-money-bill"></i> Détails tarifaires</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-coins info-icon"></i> Montant à percevoir : <strong>${normalizedData.pricing.price} ${normalizedData.payment.currency}</strong></div>
                            <div class="distance-info">
                                <div class="distance-item">
                                    <i class="fas fa-route"></i>
                                    <span>Distance livreur → expéditeur: ${senderDistance} km</span>
                                </div>
                                <div class="distance-item">
                                    <i class="fas fa-truck"></i>
                                    <span>Distance expéditeur → destinataire: ${deliveryDistance} km</span>
                                </div>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-credit-card info-icon"></i> Paiement : 
                                ${normalizedData.payment.method === 'delivery' ? '<strong>à la livraison (encaisser le client)</strong>' : 'prépayé'}
                                (${normalizedData.payment.status})
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        ${!isAssigned ? `
                            <button class="btn btn-primary accept-btn" data-id="${normalizedData.id}" data-service="packages">
                                <i class="fas fa-check"></i> <span class="btn-text">Accepter cette livraison</span>
                            </button>
                        ` : isMyOrder ? `
                            <button class="btn btn-warning update-position-btn" data-id="${normalizedData.id}" data-service="packages">
                                <i class="fas fa-map-marker-alt"></i> <span class="btn-text">Mettre à jour ma position</span>
                            </button>
                            <button class="btn btn-success complete-btn" data-id="${normalizedData.id}" data-service="packages">
                                <i class="fas fa-flag-checkered"></i> <span class="btn-text">Terminer la livraison</span>
                            </button>
                        ` : `
                            <div class="assignment-alert">
                                <div class="alert-icon">⚠️</div>
                                <div class="alert-text">Cette commande est déjà prise en charge par un autre livreur</div>
                            </div>
                        `}
                    </div>
                `;
            }

            generateFoodCard(order) {
                const orderId = this.getOrderId(order, 'food') || order._id || 'N/A';
                const isAssigned = this.isOrderAssigned(order);
                const isMyOrder = this.isMyOrder(order);

                const restaurant = order.restaurant || {};
                const client = order.client || {};
                const items = order.items || [];

                const clientPosition = client.position || {};
                const restoPosition = restaurant.position || order.position || {};
                const livreurPosition = this.state.currentLocation || {};

                const distLivreurToResto = this.calculateDistanceBetween(livreurPosition, restoPosition);
                const distRestoToClient = this.calculateDistanceBetween(restoPosition, clientPosition);

                const platDetails = items.map(item => `
                    <li class="item-detail">
                        <span class="item-qty">${item.quantity}×</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${item.price.toLocaleString('fr-FR')} FCFA</span>
                    </li>
                `).join('');

                let assignmentBadge = '';
                if (isAssigned) {
                    if (isMyOrder) {
                        assignmentBadge = `
                            <div class="assignment-badge my-assignment">
                                <i class="fas fa-user-check"></i> Mes assignations
                            </div>
                        `;
                    } else {
                        const driverName = order.driverName || 'Livreur';
                        assignmentBadge = `
                            <div class="assignment-badge other-assignment">
                                <i class="fas fa-user-clock"></i> Assigné à ${driverName}
                            </div>
                        `;
                    }
                }

                const generateMapLink = (lat, lng) => `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;

                return `
                    <div class="order-header">
                        <h2 class="order-title">Commande #${order.codeCommande || orderId}</h2>
                        <p class="order-subtitle">Commande de nourriture</p>
                        ${assignmentBadge}
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-utensils"></i> Restaurant</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-store info-icon"></i><strong>${restaurant.name || 'N/A'}</strong></div>
                            <div class="info-row"><i class="fas fa-route info-icon"></i>Distance du livreur: ${distLivreurToResto} km</div>
                            ${restoPosition.latitude && restoPosition.longitude ? `
                                <div class="info-row">
                                    <i class="fas fa-map-marker-alt info-icon"></i>
                                    <a class="btn-map" href="${generateMapLink(restoPosition.latitude, restoPosition.longitude)}" target="_blank">
                                        📍 Localiser le restaurant
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-user"></i> Client</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-user info-icon"></i><strong>${client.name || 'N/A'}</strong></div>
                            <div class="info-row"><i class="fas fa-phone info-icon"></i>${client.phone || 'N/A'}</div>
                            <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i>${client.address || 'N/A'}</div>
                            <div class="info-row"><i class="fas fa-truck info-icon"></i>Distance restaurant → client: ${distRestoToClient} km</div>
                            ${clientPosition.latitude && clientPosition.longitude ? `
                                <div class="info-row">
                                    <i class="fas fa-location-arrow info-icon"></i>
                                    <a class="btn-map" href="${generateMapLink(clientPosition.latitude, clientPosition.longitude)}" target="_blank">
                                        🏠 Localiser le client
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-list"></i> Détails de la commande</div>
                        <div class="section-content">
                            <ul class="items-list">${platDetails}</ul>
                            <div class="info-row"><i class="fas fa-calculator info-icon"></i><strong>Sous-total :</strong> ${order.subtotal?.toLocaleString('fr-FR') ?? 'N/A'} FCFA</div>
                            <div class="info-row"><i class="fas fa-motorcycle info-icon"></i><strong>Frais de livraison :</strong> ${order.deliveryFee?.toLocaleString('fr-FR') ?? 'N/A'} FCFA</div>
                            <div class="info-row"><i class="fas fa-money-bill-wave info-icon"></i><strong>Total :</strong> ${order.total?.toLocaleString('fr-FR') ?? 'N/A'} FCFA</div>
                            <div class="info-row"><i class="fas fa-sticky-note info-icon"></i><strong>Note :</strong> ${order.notes || 'Aucune'}</div>
                            <div class="info-row"><i class="fas fa-credit-card info-icon"></i><strong>Méthode de paiement :</strong> ${order.payment_method === 'on_delivery' ? 'Paiement à la livraison' : (order.payment_method || 'N/A')}</div>
                            <div class="info-row"><i class="fas fa-check-circle info-icon"></i><strong>Statut du paiement :</strong> ${order.payment_status || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        ${!isAssigned ? `
                            <button class="btn btn-primary accept-btn" data-id="${orderId}" data-service="food">
                                <i class="fas fa-check"></i> Accepter la commande
                            </button>
                        ` : isMyOrder ? `
                            <button class="btn btn-success complete-btn" data-id="${orderId}" data-service="food">
                                <i class="fas fa-flag-checkered"></i> Livraison terminée
                            </button>
                        ` : `
                            <div class="assignment-alert">
                                <div class="alert-icon">⚠️</div>
                                <div class="alert-text">Cette commande est déjà prise en charge par un autre livreur</div>
                            </div>
                        `}
                    </div>
                `;
            }

            generateShoppingCard(order) {
                const orderId = order._id || this.getOrderId(order, 'shopping');
                const isAssigned = this.isOrderAssigned(order);
                const isMyOrder = this.isMyOrder(order);

                const shoppingList = order.shoppingList || [];
                const budgetMin = order.budgetMin || 'N/A';
                const budgetMax = order.budgetMax || 'N/A';
                const specialInstructions = order.specialInstructions || 'Aucune instruction spéciale';
                const phone1 = order.phone1 || 'N/A';
                const deliveryFee = order.deliveryFee != null ? order.deliveryFee : 'N/A';
                const clientPos = order.clientPosition || {};
                const latitude = clientPos.latitude;
                const longitude = clientPos.longitude;
                const accuracy = clientPos.accuracy != null ? clientPos.accuracy : 'N/A';
                const distanceToClient = (latitude && longitude)
                    ? this.calculateDistance({ latitude, longitude })
                    : 'N/A';
                const googleMapsLink = (latitude && longitude)
                    ? `https://www.google.com/maps?q=${latitude},${longitude}`
                    : '#';
                const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleString('fr-FR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                }) : 'Date inconnue';
                const status = order.status || 'N/A';
                const paymentMethod = order.payment_method || 'N/A';

                let assignmentBadge = '';
                if (isAssigned) {
                    if (isMyOrder) {
                        assignmentBadge = `
                            <div class="assignment-badge my-assignment">
                                <i class="fas fa-user-check"></i> Mes assignations
                            </div>
                        `;
                    } else {
                        const driverName = order.driverName || 'Livreur';
                        assignmentBadge = `
                            <div class="assignment-badge other-assignment">
                                <i class="fas fa-user-clock"></i> Assigné à ${driverName}
                            </div>
                        `;
                    }
                }

                return `
                    <div class="order-header">
                        <h4 class="order-title">🛒 Commande #${orderId}</h4>
                        ${assignmentBadge}
                        <span class="order-subtitle">Statut: ${status}</span>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-list-ul"></i> Détails de la commande</div>
                        <div class="section-content">
                            <ul class="info-list">
                                ${
                                    shoppingList.length
                                    ? shoppingList.map(item => `
                                        <div class="info-row">
                                            <i class="fas fa-shopping-cart info-icon"></i>
                                            <div>
                                                <strong>${item.nom}</strong> (Quantité: ${item.quantite})<br>
                                                <small>Instruction: ${item.instruction || 'Aucune'}</small>
                                            </div>
                                        </div>
                                    `).join('')
                                    : `<div class="info-row"><i class="fas fa-info-circle info-icon"></i>Aucun article listé</div>`
                                }
                            </ul>
                            <div class="info-row"><i class="fas fa-money-bill info-icon"></i><strong>Budget estimé :</strong> ${budgetMin} - ${budgetMax} FCFA</div>
                            <div class="info-row"><i class="fas fa-clipboard-list info-icon"></i><strong>Instructions spéciales :</strong> <em>${specialInstructions}</em></div>
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-user"></i> Informations client</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-phone info-icon"></i><strong>Téléphone :</strong> ${phone1}</div>
                            <div class="info-row"><i class="fas fa-coins info-icon"></i><strong>Frais de livraison :</strong> ${deliveryFee} FCFA</div>
                            <div class="info-row"><i class="fas fa-route info-icon"></i><strong>Distance livreur → client :</strong> 
                                <span class="${distanceToClient !== 'N/A' ? 'text-primary' : 'text-muted'}">${distanceToClient} km</span>
                            </div>
                            ${
                                latitude && longitude
                                ? `<div class="info-row">
                                    <i class="fas fa-map-marker-alt info-icon"></i>
                                    <strong>Position client :</strong> ${latitude.toFixed(5)}, ${longitude.toFixed(5)} (±${accuracy}m)
                                  </div>
                                  <div class="info-row">
                                    <i class="fas fa-external-link-alt info-icon"></i>
                                    <a href="${googleMapsLink}" target="_blank" class="btn-map">
                                        📍 Voir sur Google Maps
                                    </a>
                                  </div>`
                                : `<div class="info-row"><i class="fas fa-exclamation-triangle info-icon"></i><strong>Position client :</strong> Non disponible</div>`
                            }
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-clock"></i> Informations de commande</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-calendar info-icon"></i><strong>Date de la commande :</strong> ${orderDate}</div>
                            <div class="info-row"><i class="fas fa-credit-card info-icon"></i><strong>Méthode de paiement :</strong> ${paymentMethod}</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        ${
                            !isAssigned
                            ? `<button class="btn btn-primary accept-btn" data-id="${orderId}" data-service="shopping">
                                <i class="fas fa-check-circle"></i> Accepter la commande
                            </button>`
                            : isMyOrder
                            ? `<button class="btn btn-success complete-btn" data-id="${orderId}" data-service="shopping">
                                <i class="fas fa-flag-checkered"></i> Marquer comme terminé
                            </button>`
                            : `<div class="assignment-alert">
                                <div class="alert-icon">⚠️</div>
                                <div class="alert-text">Cette commande est déjà prise en charge par un autre livreur</div>
                            </div>`
                        }
                    </div>
                `;
            }

            generatePharmacyCard(order) {
                const orderId = this.getOrderId(order, 'pharmacy');
                const isAssigned = this.isOrderAssigned(order);
                const isMyOrder = this.isMyOrder(order);

                const medicamentsList = (order.medicaments || []).map(med => `
                    <div class="info-row">
                        <i class="fas fa-pills info-icon"></i>
                        <div>
                            <strong>${med.name}</strong> — Quantité: ${med.quantity}
                            ${med.notes ? `<br><small>Note: ${med.notes}</small>` : ''}
                        </div>
                    </div>
                `).join('');

                const ordonnanceImg = order.ordonnance?.data
                    ? `<img src="data:${order.ordonnance.type};base64,${order.ordonnance.data}" alt="Ordonnance" class="ordonnance-img clickable-image" />`
                    : `<p class="no-ordonnance">Aucune ordonnance fournie</p>`;

                const orderDate = new Date(order.orderDate).toLocaleString('fr-FR', { dateStyle: 'medium', timeStyle: 'short' });

                const clientPos = order.clientPosition || {};
                const latitude = clientPos.latitude;
                const longitude = clientPos.longitude;
                const accuracy = clientPos.accuracy != null ? clientPos.accuracy : 'N/A';
                const distanceToClient = (latitude && longitude)
                    ? this.calculateDistance({ latitude, longitude })
                    : 'N/A';
                const googleMapsLink = (latitude && longitude)
                    ? `https://www.google.com/maps?q=${latitude},${longitude}`
                    : '#';

                let assignmentBadge = '';
                if (isAssigned) {
                    if (isMyOrder) {
                        assignmentBadge = `
                            <div class="assignment-badge my-assignment">
                                <i class="fas fa-user-check"></i> Mes assignations
                            </div>
                        `;
                    } else {
                        const driverName = order.driverName || 'Livreur';
                        assignmentBadge = `
                            <div class="assignment-badge other-assignment">
                                <i class="fas fa-user-clock"></i> Assigné à ${driverName}
                            </div>
                        `;
                    }
                }

                return `
                    <div class="order-header">
                        <h2 class="order-title">Pharmacie #${orderId}</h2>
                        <p class="order-subtitle">Commande de médicaments</p>
                        ${assignmentBadge}
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-pills"></i> Médicaments commandés</div>
                        <div class="section-content">
                            ${medicamentsList || '<div class="info-row"><i class="fas fa-info-circle info-icon"></i>Aucun médicament listé</div>'}
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-prescription"></i> Ordonnance</div>
                        <div class="section-content">
                            ${ordonnanceImg}
                        </div>
                    </div>

                    <div class="order-section">
                        <div class="section-title"><i class="fas fa-user"></i> Informations client</div>
                        <div class="section-content">
                            <div class="info-row"><i class="fas fa-phone info-icon"></i><strong>Téléphone :</strong> <a href="tel:${order.phoneNumber}" class="phone-link">${order.phoneNumber}</a></div>
                            ${order.notes ? `<div class="info-row"><i class="fas fa-sticky-note info-icon"></i><strong>Notes :</strong> ${order.notes}</div>` : ''}
                            <div class="info-row"><i class="fas fa-calendar info-icon"></i><strong>Date commande :</strong> ${orderDate}</div>
                            <div class="info-row"><i class="fas fa-money-bill info-icon"></i><strong>Frais de livraison :</strong> ${order.deliveryFee.toLocaleString('fr-FR')} FCFA</div>
                            <div class="info-row"><i class="fas fa-credit-card info-icon"></i><strong>Mode de paiement :</strong> ${order.payment_method.replace('_', ' ')}</div>
                            <div class="info-row"><i class="fas fa-route info-icon"></i><strong>Distance livreur → client :</strong> ${distanceToClient} km</div>
                            ${
                                latitude && longitude
                                ? `<div class="info-row">
                                    <i class="fas fa-map-marker-alt info-icon"></i>
                                    <strong>Position client :</strong> ${latitude.toFixed(5)}, ${longitude.toFixed(5)} (±${accuracy}m)
                                  </div>
                                  <div class="info-row">
                                    <i class="fas fa-external-link-alt info-icon"></i>
                                    <a href="${googleMapsLink}" target="_blank" class="btn-map">
                                        📍 Voir sur Google Maps
                                    </a>
                                  </div>`
                                : `<div class="info-row"><i class="fas fa-exclamation-triangle info-icon"></i><strong>Position client :</strong> Non disponible</div>`
                            }
                        </div>
                    </div>

                    <div class="action-buttons">
                        ${!isAssigned ? `
                            <button class="btn btn-primary accept-btn" data-id="${orderId}" data-service="pharmacy">
                                <i class="fas fa-check"></i> Accepter la commande
                            </button>
                        ` : isMyOrder ? `
                            <button class="btn btn-success complete-btn" data-id="${orderId}" data-service="pharmacy">
                                <i class="fas fa-flag-checkered"></i> Livraison terminée
                            </button>
                        ` : `
                            <div class="assignment-alert">
                                <div class="alert-icon">⚠️</div>
                                <div class="alert-text">Cette commande est déjà prise en charge par un autre livreur</div>
                            </div>
                        `}
                    </div>
                `;
            }

            generatePhotosSection(photos) {
                if (!photos || photos.length === 0) {
                    return `
                        <div class="order-section">
                            <div class="section-title">
                                <i class="fas fa-camera"></i>
                                Photos du colis
                            </div>
                            <div class="section-content">
                                <div class="package-photos">
                                    <div class="package-photo">
                                        <div class="no-photo-placeholder">
                                            <i class="fas fa-image"></i><br>
                                            Aucune photo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const photoGrid = photos.map((photo, index) => {
                    const photoSrc = photo.vignette || photo.thumbnail || photo.data || photo.url || '';
                    const photoName = photo.nom || photo.name || `Photo ${index + 1}`;
                    
                    return `
                        <div class="package-photo" onclick="showPhoto('${photoSrc}', '${photoName}')">
                            ${photoSrc ? `
                                <img src="${photoSrc}" alt="${photoName}" class="clickable-image" onerror="this.parentElement.innerHTML='<div class=&quot;no-photo-placeholder&quot;>Erreur de chargement</div>'">
                                <div class="photo-overlay">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                </div>
                            ` : `
                                <div class="no-photo-placeholder">
                                    <i class="fas fa-image"></i><br>
                                    Photo indisponible
                                </div>
                            `}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="order-section">
                        <div class="section-title">
                            <i class="fas fa-camera"></i>
                            Photos du colis (${photos.length})
                        </div>
                        <div class="section-content">
                            <div class="package-photos">
                                ${photoGrid}
                            </div>
                        </div>
                    </div>
                `;
            }

            setupCardEvents(card, order, serviceType) {
                const orderId = this.getOrderId(order, serviceType);
                
                const acceptBtn = card.querySelector('.accept-btn');
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', () => {
                        this.state.currentOrder = { ...order, serviceType, id: orderId };
                        
                        if (this.state.driverInfo) {
                            document.getElementById('driverName').value = this.state.driverInfo.driverName || '';
                            document.getElementById('driverId').value = this.state.driverInfo.driverId || '';
                            document.getElementById('driverPhone1').value = this.state.driverInfo.driverPhone1 || '';
                            document.getElementById('driverPhone2').value = this.state.driverInfo.driverPhone2 || '';
                        }
                        
                        this.dom.modals.accept.classList.add('active');
                    });
                }

                const updateBtn = card.querySelector('.update-position-btn');
                if (updateBtn) {
                    updateBtn.addEventListener('click', () => {
                        this.state.currentUpdateOrderId = orderId;
                        this.dom.modals.verify.classList.add('active');
                    });
                }

                const completeBtn = card.querySelector('.complete-btn');
                if (completeBtn) {
                    completeBtn.addEventListener('click', () => {
                        this.state.currentOrder = { ...order, serviceType, id: orderId };
                        
                        if (this.state.driverInfo) {
                            document.getElementById('completeName').value = this.state.driverInfo.driverName || '';
                            document.getElementById('completeId').value = this.state.driverInfo.driverId || '';
                        }
                        
                        this.dom.modals.complete.classList.add('active');
                    });
                }
            }

            async toggleTracking() {
                if (this.state.isTrackingActive) {
                    await this.stopTracking();
                } else {
                    await this.startTracking();
                }
            }

            async startTracking(isRestoration = false) {
                if (this.state.isTrackingActive && !isRestoration) return;

                try {
                    this.state.isTrackingActive = true;
                    if (!isRestoration) {
                        this.state.trackingStartTime = Date.now();
                        this.state.positionsSent = 0;
                    }

                    await this.saveSession();
                    this.updateTrackingUI();
                    this.showTrackingNotification();

                } catch (error) {
                    console.error('Erreur de démarrage du suivi:', error);
                    this.showToast(error.message || 'Erreur d\'activation du suivi GPS', 'error');
                }
            }

            async stopTracking() {
                if (!this.state.isTrackingActive) return;

                try {
                    this.state.isTrackingActive = false;
                    this.state.trackingStartTime = null;
                    
                    await this.saveSession();
                    this.updateTrackingUI();
                    this.hideTrackingNotification();
                    
                    this.showToast('Suivi GPS désactivé', 'info');
                } catch (error) {
                    console.error('Erreur d\'arrêt du suivi:', error);
                    this.showToast('Erreur lors de l\'arrêt du suivi', 'error');
                }
            }

            updateTrackingUI() {
                const toggle = this.dom.trackingToggle;
                const status = this.dom.trackingStatus;
                const indicator = this.dom.statusIndicator;

                if (this.state.isTrackingActive) {
                    toggle.classList.add('active');
                    status.textContent = 'Actif';
                    indicator.classList.add('tracking');
                } else {
                    toggle.classList.remove('active');
                    status.textContent = 'Inactif';
                    indicator.classList.remove('tracking');
                }
            }

            updateTrackingMetrics() {
                if (this.dom.positionsSent) {
                    this.dom.positionsSent.textContent = this.state.positionsSent;
                }
                
                if (this.dom.trackingAccuracy && this.state.trackingAccuracy) {
                    this.dom.trackingAccuracy.textContent = `±${this.state.trackingAccuracy}m`;
                }
            }

            startTrackingDurationUpdate() {
                setInterval(() => {
                    if (this.state.isTrackingActive && this.state.trackingStartTime) {
                        const duration = Date.now() - this.state.trackingStartTime;
                        const hours = Math.floor(duration / 3600000);
                        const minutes = Math.floor((duration % 3600000) / 60000);
                        this.dom.trackingDuration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    } else {
                        this.dom.trackingDuration.textContent = '00:00';
                    }
                }, 1000);
            }

            showTrackingNotification() {
                this.dom.trackingNotification.classList.add('active');
                setTimeout(() => {
                    this.hideTrackingNotification();
                }, 8000);
            }

            hideTrackingNotification() {
                this.dom.trackingNotification.classList.remove('active');
            }

            async acceptOrder() {
                const confirmButton = document.getElementById('confirmAccept');
                
                const driverName = document.getElementById('driverName').value.trim();
                const driverId = document.getElementById('driverId').value.trim();
                const driverPhone1 = document.getElementById('driverPhone1').value.trim();
                const driverPhone2 = document.getElementById('driverPhone2').value.trim();

                if (!driverName || !driverId || !driverPhone1) {
                    this.showToast('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }

                this.setButtonLoading(confirmButton, true, 'Acceptation en cours...');

                try {
                    if (!this.state.currentLocation) {
                        await this.getLocation();
                        if (!this.state.currentLocation) {
                            throw new Error('Impossible d\'obtenir votre position');
                        }
                    }

                    this.saveDriverInfo({ driverName, driverId, driverPhone1, driverPhone2 });

                    const response = await fetch(`${this.config.API_BASE_URL}assignDriverToOrder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: this.state.currentOrder.id,
                            serviceType: this.state.currentOrder.serviceType,
                            driverName,
                            driverId,
                            driverPhone1,
                            driverPhone2,
                            driverLocation: this.state.currentLocation
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Fermer le modal d'acceptation
                        this.dom.modals.accept.classList.remove('active');
                        
                        // Ouvrir immédiatement le modal SMS obligatoire
                        this.showSmsModal();
                        
                        this.state.assignedOrders.add(this.state.currentOrder.id.toString());

                    } else {
                        if (response.status === 409 || result.isAlreadyAssigned) {
                            this.showToast(result.error, 'warning');
                            if (this.state.activeService) {
                                await this.loadOrders(this.state.activeService);
                            }
                        } else {
                            throw new Error(result.error || 'Erreur lors de l\'acceptation de la commande');
                        }
                    }
                } catch (error) {
                    console.error('Erreur acceptation commande:', error);
                    this.showToast(error.message || 'Erreur lors de l\'acceptation. Veuillez réessayer.', 'error');
                } finally {
                    this.setButtonLoading(confirmButton, false);
                }
            }

showSmsModal() {
    const order = this.state.currentOrder;
    const smsModal = this.dom.modals.sms;
    
    // Déterminer les numéros selon le service
    let expediteurPhone = 'Non disponible';
    let destinatairePhone = 'Non disponible';
    let useWhatsAppForExpediteur = false;
    
    if (order.serviceType === 'packages') {
        expediteurPhone = order.expediteur?.telephone || 'Non disponible';
        destinatairePhone = order.destinataire?.telephone || 'Non disponible';
    } else {
        // Pour food, shopping et pharmacy, on utilise WhatsApp pour l'expéditeur
        expediteurPhone = '61229766'; // Numéro de l'entreprise
        useWhatsAppForExpediteur = true;
        
        if (order.serviceType === 'food') {
            destinatairePhone = order.client?.phone || 'Non disponible';
        } else {
            destinatairePhone = order.phone1 || order.phoneNumber || 'Non disponible';
        }
    }

    // Messages personnalisés
    const driverName = this.state.driverInfo?.driverName || 'Livreur SEND 2.0';
    const driverPhone = this.state.driverInfo?.driverPhone1 || 'Non spécifié';
    const orderId = order.id;

    const messageExpediteur = `🚚 SEND 2.0 - Commande #${orderId} prise en charge par ${driverName}. Contact: ${driverPhone}.`;
    const messageDestinataire = `📦 SEND 2.0 - Votre livraison #${orderId} est en route ! Livreur: ${driverName} (${driverPhone}).`;

    // Remplir les éléments du modal
    document.getElementById('expediteurPhone').textContent = 
        useWhatsAppForExpediteur ? 'WhatsApp Entreprise (61229766)' : expediteurPhone;
    document.getElementById('destinatairePhone').textContent = destinatairePhone;
    document.getElementById('smsExpediteur').value = messageExpediteur;
    document.getElementById('smsDestinataire').value = messageDestinataire;

    // État des messages
    let messagesSent = { expediteur: false, destinataire: false };
    
    const updateConfirmButton = () => {
        const confirmBtn = document.getElementById('confirmSms');
        if (messagesSent.expediteur && messagesSent.destinataire) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<span class="btn-text">Finaliser l\'acceptation</span>';
        }
    };

    // Gestion des boutons d'envoi
    document.getElementById('sendExpediteurSms').onclick = () => {
        if (useWhatsAppForExpediteur) {
            this.sendWhatsApp('61229766', messageExpediteur);
        } else {
            this.sendSms(expediteurPhone, messageExpediteur);
        }
        
        const btn = document.getElementById('sendExpediteurSms');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-check"></i> Message envoyé ✓';
        btn.style.background = 'var(--success)';
        messagesSent.expediteur = true;
        updateConfirmButton();
    };

    document.getElementById('sendDestinataireSms').onclick = () => {
        this.sendSms(destinatairePhone, messageDestinataire);
        const btn = document.getElementById('sendDestinataireSms');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-check"></i> SMS envoyé ✓';
        btn.style.background = 'var(--success)';
        messagesSent.destinataire = true;
        updateConfirmButton();
    };

    document.getElementById('confirmSms').onclick = () => {
        smsModal.classList.remove('active');
        this.showToast('Commande acceptée avec succès ! Les parties ont été informées.', 'success');
        
        setTimeout(() => {
            if (this.state.activeService) {
                this.loadOrders(this.state.activeService);
            }
        }, 1000);
    };

    document.getElementById('cancelSms').onclick = () => {
        smsModal.classList.remove('active');
        this.showToast('Acceptation annulée. Les messages n\'ont pas été envoyés.', 'warning');
    };
    
    // Réinitialiser l'état des boutons
    const resetButtons = () => {
        const expediteurBtn = document.getElementById('sendExpediteurSms');
        const destinataireBtn = document.getElementById('sendDestinataireSms');
        const confirmBtn = document.getElementById('confirmSms');

        expediteurBtn.disabled = false;
        expediteurBtn.innerHTML = useWhatsAppForExpediteur 
            ? '<i class="fab fa-whatsapp"></i> Envoyer WhatsApp à l\'entreprise' 
            : '<i class="fas fa-sms"></i> Envoyer SMS à l\'expéditeur';
        expediteurBtn.style.background = '';

        destinataireBtn.disabled = false;
        destinataireBtn.innerHTML = '<i class="fas fa-sms"></i> Envoyer SMS au destinataire';
        destinataireBtn.style.background = '';

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="btn-text">Envoyez d\'abord les 2 messages</span>';

        messagesSent = { expediteur: false, destinataire: false };
    };

    // Mettre à jour le texte du bouton WhatsApp
    const expediteurBtn = document.getElementById('sendExpediteurSms');
    if (useWhatsAppForExpediteur) {
        expediteurBtn.innerHTML = '<i class="fab fa-whatsapp"></i> Envoyer WhatsApp à l\'entreprise';
    }

    resetButtons();
    smsModal.classList.add('active');
}



sendWhatsApp(phoneNumber, message) {
    if (!phoneNumber) {
        this.showToast('Numéro WhatsApp invalide', 'error');
        return;
    }
    
    // Nettoyer le numéro (supprimer tous les caractères non numériques)
    const cleanPhone = phoneNumber.replace(/\D/g, '');
    
    // Créer le lien WhatsApp
    const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
    
    try {
        // Ouvrir WhatsApp dans un nouvel onglet
        window.open(whatsappUrl, '_blank');
        this.showToast('Application WhatsApp ouverte', 'info');
    } catch (error) {
        console.error('Erreur ouverture WhatsApp:', error);
        this.showToast('Impossible d\'ouvrir WhatsApp', 'error');
        
        // Fallback: Ouvrir dans le même onglet si window.open échoue
        window.location.href = whatsappUrl;
    }
}

            sendSms(phoneNumber, message) {
                if (!phoneNumber || phoneNumber === 'Non disponible') {
                    this.showToast('Numéro de téléphone invalide', 'error');
                    return;
                }
                
                const cleanPhone = phoneNumber.replace(/\D/g, '');
                
                // Ouvrir l'application SMS native
                const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(message)}`;
                
                try {
                    window.open(smsUrl, '_blank');
                    this.showToast('Application SMS ouverte', 'info');
                } catch (error) {
                    console.error('Erreur ouverture SMS:', error);
                    this.showToast('Impossible d\'ouvrir l\'application SMS', 'error');
                }
            }

            async completeOrder() {
                const confirmButton = document.getElementById('confirmComplete');
                
                const driverName = document.getElementById('completeName').value.trim();
                const driverId = document.getElementById('completeId').value.trim();
                const notes = document.getElementById('completeNotes').value.trim();

                if (!driverName || !driverId) {
                    this.showToast('Nom et identifiant du livreur sont obligatoires', 'error');
                    return;
                }

                this.setButtonLoading(confirmButton, true, 'Finalisation en cours...');

                try {
                    const response = await fetch(`${this.config.API_BASE_URL}completeOrder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderId: this.state.currentOrder.id,
                            serviceType: this.state.currentOrder.serviceType,
                            driverName,
                            driverId,
                            notes,
                            completionLocation: this.state.currentLocation,
                            completedAt: new Date().toISOString()
                        })
                    });

                    if (response.ok) {
                        this.showToast('Livraison finalisée avec succès ! La commande a été archivée.', 'success');
                        this.dom.modals.complete.classList.remove('active');
                        document.getElementById('completeForm').reset();
                        
                        this.state.assignedOrders.delete(this.state.currentOrder.id.toString());
                        this.state.stats.ordersCompleted++;
                        
                        if (this.state.activeService) {
                            await this.loadOrders(this.state.activeService);
                        }
                    } else {
                        const result = await response.json();
                        throw new Error(result.error || 'Erreur lors de la finalisation de la livraison');
                    }
                } catch (error) {
                    console.error('Erreur finalisation livraison:', error);
                    this.showToast(error.message || 'Erreur lors de la finalisation. Veuillez réessayer.', 'error');
                } finally {
                    this.setButtonLoading(confirmButton, false);
                }
            }

            async verifyAndUpdatePosition() {
                const confirmButton = document.getElementById('confirmVerify');
                const driverId = document.getElementById('verifyDriverId').value.trim();

                if (!driverId) {
                    this.showToast('Veuillez saisir votre identifiant', 'error');
                    return;
                }

                this.setButtonLoading(confirmButton, true, 'Vérification...');

                try {
                    const position = await this.getCurrentPosition();
                    const { latitude, longitude, accuracy } = position.coords;

                    const locationData = {
                        latitude,
                        longitude,
                        accuracy,
                        timestamp: new Date().toISOString()
                    };

                    const response = await fetch(`${this.config.API_BASE_URL}updateDriverPosition`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: this.state.currentUpdateOrderId,
                            driverId,
                            location: locationData
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Erreur serveur');

                    this.state.currentLocation = locationData;
                    this.showToast('Position mise à jour avec succès', 'success');
                    this.dom.modals.verify.classList.remove('active');

                } catch (error) {
                    console.error('Erreur:', error);
                    this.showToast(error.message || 'Erreur de mise à jour', 'error');
                } finally {
                    this.setButtonLoading(confirmButton, false);
                }
            }

            async loadAssignedOrders() {
                if (!this.state.driverInfo?.driverId) return;

                try {
                    const response = await fetch(`${this.config.API_BASE_URL}getOrders?driverId=${this.state.driverInfo.driverId}`);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    const orders = data.orders || [];

                    orders.forEach(order => {
                        this.state.assignedOrders.add(order.id?.toString() || order._id?.toString());
                    });

                    return orders;
                } catch (error) {
                    console.error('Erreur chargement commandes assignées:', error);
                    return [];
                }
            }

            // === MÉTHODES UTILITAIRES ===

            isOrderAssigned(order) {
                const status = (order.status || order.statut || '').toLowerCase();
                return status.includes('assigned') || status.includes('assigné') || 
                       status === 'en_cours_de_livraison' || 
                       order.driverId || order.idLivreurEnCharge || 
                       order.driverName || order.nomLivreur;
            }

            isMyOrder(order) {
                if (!this.state.driverInfo?.driverId) return false;
                return order.driverId === this.state.driverInfo.driverId || 
                       order.idLivreurEnCharge === this.state.driverInfo.driverId;
            }

            getOrderId(order, serviceType) {
                switch(serviceType) {
                    case 'packages':
                        return order.colisID || order._id;
                    case 'food':
                        return order.identifiant || order._id;
                    default:
                        return order._id || order.id;
                }
            }

            getTargetLocation(order, serviceType) {
                switch(serviceType) {
                    case 'packages':
                        return order.expediteur?.location;
                    case 'food':
                        return order.restaurant?.position || order.client?.position;
                    case 'shopping':
                    case 'pharmacy':
                        return order.clientPosition;
                    default:
                        return null;
                }
            }

            getOrderPrice(order, serviceType) {
                switch(serviceType) {
                    case 'packages':
                        if (order.payment?.method === 'delivery') {
                            return order.pricing?.price || order.price || 0;
                        } else {
                            return order.pricing?.deliveryFee || 0;
                        }
                    case 'food':
                        return order.deliveryFee || order.delivery_fee || 0;
                    case 'shopping':
                    case 'pharmacy':
                        return order.deliveryFee || 1000;
                    default:
                        return 0;
                }
            }

            calculateDistance(targetLocation) {
                if (!this.state.currentLocation || !targetLocation?.latitude || !targetLocation?.longitude) {
                    return 'N/A';
                }

                const R = 6371;
                const dLat = (targetLocation.latitude - this.state.currentLocation.latitude) * Math.PI / 180;
                const dLon = (targetLocation.longitude - this.state.currentLocation.longitude) * Math.PI / 180;
                
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.state.currentLocation.latitude * Math.PI / 180) * 
                    Math.cos(targetLocation.latitude * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return (R * c).toFixed(1);
            }

            calculateDistanceBetween(location1, location2) {
                if (!location1 || !location2 || 
                    !location1.latitude || !location1.longitude ||
                    !location2.latitude || !location2.longitude) {
                    return 'N/A';
                }
                
                const R = 6371;
                const dLat = (location2.latitude - location1.latitude) * Math.PI / 180;
                const dLon = (location2.longitude - location1.longitude) * Math.PI / 180;
                
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(location1.latitude * Math.PI / 180) * 
                          Math.cos(location2.latitude * Math.PI / 180) * 
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return (R * c).toFixed(2);
            }

            updateServiceCount(serviceType, count) {
                const countElement = document.getElementById(`count-${serviceType}`);
                if (countElement) {
                    countElement.textContent = count;
                    countElement.style.display = count > 0 ? 'block' : 'none';
                }
            }

            showErrorState(serviceType, error) {
                const orderList = this.dom.orderLists[serviceType];
                if (!orderList) return;
                
                orderList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <div class="empty-title">Erreur de chargement</div>
                        <div class="empty-message">${error.message}</div>
                        <button class="btn btn-primary" onclick="app.loadOrders('${serviceType}')" style="margin-top: 16px;">
                            <i class="fas fa-redo"></i>
                            <span class="btn-text">Réessayer</span>
                        </button>
                    </div>
                `;
            }

            saveDriverInfo(info) {
                this.state.driverInfo = info;
                this.saveSession();
            }

            cleanCoordinate(coord) {
                if (!coord && coord !== 0) return null;
                if (typeof coord === 'string') {
                    return parseFloat(coord.replace(',', '.'));
                }
                return parseFloat(coord);
            }

            formatPhoneNumber(phone) {
                if (!phone) return null;
                const cleaned = phone.toString().replace(/\D/g, '');
                if (cleaned.length === 8) {
                    return cleaned.replace(/(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4');
                }
                return phone;
            }

            setButtonLoading(button, isLoading, loadingText = 'Traitement en cours...') {
                if (!button) return;
                
                if (isLoading) {
                    button.classList.add('loading');
                    button.disabled = true;
                    
                    const textElement = button.querySelector('.btn-text');
                    if (textElement) {
                        textElement.dataset.originalText = textElement.textContent;
                        textElement.textContent = loadingText;
                    }
                    
                    const existingSpinner = button.querySelector('.btn-spinner');
                    if (!existingSpinner) {
                        const spinner = document.createElement('div');
                        spinner.className = 'btn-spinner';
                        button.insertBefore(spinner, button.firstChild);
                    }
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                    
                    const textElement = button.querySelector('.btn-text');
                    if (textElement && textElement.dataset.originalText) {
                        textElement.textContent = textElement.dataset.originalText;
                        delete textElement.dataset.originalText;
                    }
                    
                    const spinner = button.querySelector('.btn-spinner');
                    if (spinner) {
                        spinner.remove();
                    }
                }
            }

            async getCurrentPosition() {
                return await CapacitorPlugins.Geolocation.getCurrentPosition({
                    enableHighAccuracy: this.config.GEOLOCATION.HIGH_ACCURACY,
                    timeout: this.config.GEOLOCATION.TIMEOUT,
                    maximumAge: this.config.GEOLOCATION.MAX_AGE
                });
            }

            showToast(message, type = 'info') {
                const toastId = 'toast-' + Date.now();
                const iconSvg = this.getToastIcon(type);
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon ${type}">${iconSvg}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                this.dom.toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    const toastElement = document.getElementById(toastId);
                    if (toastElement) {
                        toastElement.style.animation = 'toastSlideInLeft 0.3s ease-out reverse';
                        setTimeout(() => toastElement.remove(), 300);
                    }
                }, 6000);
            }

            getToastIcon(type) {
                const icons = {
                    success: '<i class="fas fa-check-circle"></i>',
                    error: '<i class="fas fa-times-circle"></i>',
                    warning: '<i class="fas fa-exclamation-triangle"></i>',
                    info: '<i class="fas fa-info-circle"></i>'
                };
                
                return icons[type] || icons.info;
            }

            async saveSession() {
                try {
                    await CapacitorPlugins.Preferences.set({
                        key: 'driverSession',
                        value: JSON.stringify({
                            driverInfo: this.state.driverInfo,
                            isTrackingActive: this.state.isTrackingActive,
                            trackingStartTime: this.state.trackingStartTime,
                            positionsSent: this.state.positionsSent,
                            stats: this.state.stats,
                            filters: this.state.filters
                        })
                    });
                } catch (error) {
                    console.error('Erreur de sauvegarde de session:', error);
                }
            }

            startAutoRefresh() {
                setInterval(async () => {
                    if (this.state.activeService && this.state.onlineStatus) {
                        await this.loadOrders(this.state.activeService);
                    }
                }, this.config.REFRESH_INTERVAL);
            }
        }

        // === FONCTIONS GLOBALES ===
        function showPhoto(src, alt) {
            if (window.app) {
                window.app.showPhoto(src, alt);
            }
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            if (modal) modal.classList.remove('active');
        }

        // === INITIALISATION ===
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            if (window.app) {
                console.warn('L\'application est déjà initialisée');
                return;
            }
            
            try {
                app = new DeliveryInterface();
                window.app = app;
                
                window.distanceFilter = new DistanceFilterSystem();
                
                console.log('🎉 Application SEND 2.0 Livreur Pro initialisée');
                console.log('Environnement:', isNative() ? 'Capacitor' : 'Navigateur');
            } catch (error) {
                console.error('Erreur d\'initialisation:', error);
                const errorElement = document.createElement('div');
                errorElement.style.position = 'fixed';
                errorElement.style.background = 'red';
                errorElement.style.color = 'white';
                errorElement.style.padding = '20px';
                errorElement.style.zIndex = '9999';
                errorElement.textContent = 'Erreur d\'initialisation de l\'application. Veuillez recharger la page.';
                document.body.appendChild(errorElement);
            }
        });

        // === GESTION ERREURS GLOBALES ===
        window.addEventListener('error', (event) => {
            console.error('Erreur globale:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise rejetée:', event.reason);
        });
    </script>
</body>
</html>